const API_BASE="https://buzzink.onrender.com",API_URL="/api/posts",AUTH_URL="/api/auth",COMMENTS_URL="/api/comments",menuToggle=document.querySelector(".menu-toggle"),mobileMenu=document.getElementById("mobileMenu"),searchIcon=document.querySelector(".search-icon"),mobileSearch=document.getElementById("mobileSearch"),logo=document.querySelector(".logo"),allPostsBtn=document.querySelector(".all-posts-btn"),myPosts=document.getElementById("myPosts"),search=document.querySelectorAll(".search"),postImages=document.querySelectorAll(".post-image"),DEFAULT_AVATAR="https://i.postimg.cc/KvF0rh0Q/custom-default-avatar.png";function normalizeUser(e){return e?{...e,id:e.id||e._id}:null}async function updateAvatar(e){try{const t=await apiFetch("/api/users/me");if(!t.ok)return;e=await t.json();const o=document.querySelectorAll(".user-icon");o&&o.forEach(t=>{t.src=e.profilePhoto?.trim()?e.profilePhoto:DEFAULT_AVATAR}),window.currentUser=e}catch(e){console.warn("Failed to load auth user:",e)}}document.getElementById("canonicalUrl")?.setAttribute("href",window.location.href),window.location.pathname.endsWith("post.html")&&(async()=>{const e=new URLSearchParams(window.location.search).get("slug");if(!e)return;const t=await apiFetch(`/api/posts/${e}`),o=await t.json();document.title=`${o.title} | BuzzInk`;const n=o.content.slice(0,160);document.getElementById("postTitle")?.setAttribute("content",o.title),document.getElementById("postDescription")?.setAttribute("content",n),document.getElementById("ogTitle")?.setAttribute("content",o.title),document.getElementById("ogDescription")?.setAttribute("content",n),document.getElementById("ogImage")?.setAttribute("content",o.image||"/Images/fallback.jpg"),document.getElementById("ogUrl")?.setAttribute("content",window.location.href),document.getElementById("twitterTitle")?.setAttribute("content",o.title),document.getElementById("twitterDescription")?.setAttribute("content",n),document.getElementById("twitterImage")?.setAttribute("content",o.image||"/Images/fallback.jpg")})(),window.currentUser=(()=>{const e=localStorage.getItem("user");return e?normalizeUser(JSON.parse(e)):null})(),logo?.addEventListener("click",()=>{window.location.href="index.html"}),allPostsBtn?.addEventListener("click",()=>{window.location.href="all-posts.html"}),myPosts?.addEventListener("click",()=>{window.location.href="my-posts.html"}),searchIcon?.addEventListener("click",()=>{mobileSearch.classList.toggle("show"),mobileSearch.classList.contains("show")&&mobileSearch.querySelector("input").focus()}),menuToggle?.addEventListener("click",e=>{e.stopPropagation(),userMenuDetails.classList.contains("show")&&userMenuDetails.classList.remove("show"),mobileMenu.classList.toggle("active")}),window.location.pathname.endsWith("write.html")&&!localStorage.getItem("editSlug")&&localStorage.removeItem("editSlug");let posts=[],currentPage=1,totalPages=1;function renderNoResults(e){e.innerHTML='<p style="text-align:center; color:gray; font-size: 20px; font-weight: bold;">No results found...</p>'}function renderNoAuthorPost(e){e.innerHTML='<p style="text-align:center; color:gray; font-size: 20px; font-weight: bold;">You haven\'t made any posts yet...</p>'}function getImageUrl(e){return e?e.startsWith("http")?e:(e.startsWith("/uploads"),"/Images/fallback.jpg"):"/Images/fallback.jpg"}async function fetchPosts(e=1,t=6){try{const o=await apiFetch(`${API_URL}?page=${e}&limit=${t}`),n=await o.json();posts=Array.isArray(n.posts)?n.posts:[],currentPage=n.currentPage,totalPages=n.totalPages,refreshPage(),renderPagination()}catch(e){console.error("Error fetching posts:",e),showToast("Failed to load posts!","error")}}async function fetchMyPosts(e=1,t=6){try{const o=await apiFetch(`${API_URL}/mine?page=${e}&limit=${t}`);if(!o.ok){const e=await o.text();throw new Error(e||"Failed to fetch your posts")}const n=await o.json();posts=Array.isArray(n.posts)?n.posts:[],currentPage=n.currentPage||1,totalPages=n.totalPages||1;if(displayPosts("myPostsContainer"),renderPagination(),0===posts.length){const e=document.getElementById("myPostsContainer");e&&renderNoAuthorPost(e)}}catch(e){console.error("Error fetching my posts:",e),showToast("Failed to load your posts!","error")}}function displayPosts(e,t=null){const o=window.currentUser?._id||window.currentUser?.id,n=document.getElementById(e);if(!n)return;n.innerHTML="";let s=[...posts];if("allPostsContainer"===e){const e=document.getElementById("categoryFilter");if(e){const t=e?.value;"all"!==t&&(s=s.filter(e=>e.category===t))}}"myPostsContainer"===e&&o&&(s=s.filter(e=>{const t="object"==typeof e.authorId&&null!==e.authorId?e.authorId._id:e.authorId;return String(t)===String(o)})),t&&(s=s.slice(0,t)),0!==s.length?s.forEach(e=>{const t=document.createElement("div");t.classList.add("post");const s=e.content.length>150?e.content.substring(0,150)+"...":e.content,a="object"==typeof e.authorId&&null!==e.authorId?e.authorId._id:e.authorId,r=o&&String(a)===String(o);t.innerHTML=`\n      ${e.image?`<a href="post.html?slug=${e.slug}">\n             <img src="${getImageUrl(e.image)}" alt="${e.title}" class="post-image" loading="lazy">\n           </a>`:""}\n        <p class="tag">${e.category}</p>\n        <h2>\n          <a href="post.html?slug=${e.slug}" class="post-link">${e.title}</a>\n        </h2>\n        <p>${s} <a href="post.html?slug=${e.slug}" class="read-more">Read more</a></p>\n        <a href="profile.html?user=${e.authorId}" class="author"><em>By ${e.authorName||"Unknown"}</em></a>\n        <small>${new Date(e.date).toLocaleString()}</small>\n        <br>\n        <div class="post-interactions-container">\n          <div class="post-interactions">\n            <button class="like-btn ${e.likedByUser?"liked":""}" data-post-id="${e._id}">\n              <i class="${e.likedByUser?"fa-solid":"fa-regular"} fa-heart"></i>\n              <span class="like-count">${e.likesCount||0}</span>\n            </button>\n            <button class="comment-btn" data-post-id="${e._id}">\n              <i class="fa-regular fa-comment"></i>\n              <span class="comment-count">${e.commentsCount||0}</span>\n            </button>\n            <button class="share-btn">\n              <i class="fa-solid fa-share"></i>\n              <span class="share-count"></span>\n            </button>\n          </div>\n          <span class="liked-by likes-info">No likes yet</span>\n        </div>\n        <div class="comments-section">\n          <form class="comment-form">\n            <input type="text" class="comment-input" placeholder="Write a comment..." required />\n            <button type="submit">Comment</button>\n          </form>\n          <div class="comments-list"></div>\n        </div>\n        ${r?`\n        <div class="post-actions">\n            <button class="edit-btn btn" data-slug="${e.slug}">Edit</button>\n            <button class="delete-btn btn" data-slug="${e.slug}">Delete</button>\n        </div>\n        `:""}\n    `,n.appendChild(t);const i=t.querySelector(".post-image");i&&(i.onerror=function(){this.onerror=null,this.src="/Images/fallback.jpg"});const l=t.querySelector(".like-btn"),c=l.querySelector("i"),d=t.querySelector(".liked-by"),m=Array.isArray(e.likes)?e.likes.map(e=>"object"==typeof e?e._id:e):[];o&&(m.includes(o)||e.likedByUser)?(l.classList.add("liked"),c.className="fa-solid fa-heart"):(l.classList.remove("liked"),c.className="fa-regular fa-heart"),e.likedBy&&0!==e.likedBy.length?1===e.likedBy.length?d.textContent=`Liked by ${e.likedBy[0]}`:d.textContent=`Liked by ${e.likedBy[0]} and ${e.likedBy.length-1} others`:d.textContent="No likes yet";const u=t.querySelector(".comment-count");updateCommentCount(e._id,u)}):renderNoResults(n)}async function addPost(e,t,o,n){const s=new FormData;s.append("title",e),s.append("content",t),s.append("category",o),n&&s.append("image",n);const a=await apiFetch(`${API_URL}`,{method:"POST",body:s});if(!a.ok)throw new Error("Failed to add post");return await a.json()}async function deletePost(e){if(confirm("Are you sure you want to delete this post?"))try{const t=await apiFetch(`${API_URL}/${e}`,{method:"DELETE"});if(!t.ok){const e=await t.text();throw new Error(e||"Failed to delete post")}showToast("Post deleted successfully!","success"),window.location.pathname.endsWith("my-posts.html")?fetchMyPosts(currentPage):fetchPosts(currentPage)}catch(e){console.error("Error deleting post:",e),showToast("Failed to delete post!","error")}}function editPost(e){localStorage.removeItem("editSlug"),localStorage.setItem("editSlug",e),window.location.href="write.html"}const postForm=document.getElementById("postForm");if(postForm){const e=localStorage.getItem("editSlug");e&&"null"!==e?((async()=>{try{const t=await apiFetch(`${API_URL}/${e}`);if(!t.ok)throw new Error("Post not found");const o=await t.json();if(document.getElementById("title").value=o.title||"",document.getElementById("content").value=o.content||"",document.getElementById("category").value=o.category||"",o.image){const e=document.getElementById("imagePreview");e.src=o.image,e.style.display="block"}}catch(e){console.error("Error loading post:",e)}})(),postForm.onsubmit=async function(t){t.preventDefault();const o=new FormData;o.append("title",document.getElementById("title").value),o.append("content",document.getElementById("content").value),o.append("category",document.getElementById("category").value);const n=document.getElementById("image").files[0];n&&o.append("image",n);try{const t=await apiFetch(`${API_URL}/${e}`,{method:"PUT",body:o});t.ok?(showToast("Post updated successfully!","success"),localStorage.removeItem("editSlug"),window.location.href="all-posts.html"):console.error("Update failed:",await t.text())}catch(e){console.error("Error updating post:",e),showToast("Failed to update post!","error")}}):(localStorage.removeItem("editSlug"),postForm?.addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("title").value,o=document.getElementById("content").value,n=document.getElementById("category").value,s=document.getElementById("image").files[0];console.log("Submitting new post:",{title:t,content:o,category:n,imageFile:s});try{const e=await addPost(t,o,n,s);console.log("Post created successfully!",e),showToast("Post created successfully!","success"),postForm.reset(),window.location.href="all-posts.html",localStorage.removeItem("editSlug")}catch(e){console.error("Error adding post:",e),showToast("Failed to add post!","error")}}))}function refreshPage(){document.getElementById("allPostsContainer")&&displayPosts("allPostsContainer"),document.getElementById("featuredPostsContainer")&&displayPosts("featuredPostsContainer",3),document.getElementById("myPostsContainer")&&displayPosts("myPostsContainer")}function searchPosts(e){const t=e.target.value.toLowerCase()||"",o=document.getElementById("allPostsContainer")?"allPostsContainer":"featuredPostsContainer",n=document.getElementById(o);if(!n)return;const s=posts.filter(e=>e.title.toLowerCase().includes(t)||e.content.toLowerCase().includes(t)||e.category.toLowerCase().includes(t));n.innerHTML="",0!==s.length?(s.forEach(e=>{const t=document.createElement("div");t.classList.add("post"),t.innerHTML=`\n      ${e.image?`<img src="${getImageUrl(e.image)}" alt="${e.title}" class="post-image" loading="lazy">`:""}\n      <div class="post-content">\n        <p class="tag">${e.category}</p>\n        <h2>${e.title}</h2>\n        <p>${e.content}</p>\n        <p><em>By ${e.authorName||"Unknown"}</em></p>\n        <small>${new Date(e.date).toLocaleString()}</small>\n      </div>\n    `,n.appendChild(t);const o=t.querySelector(".post-image");o&&(o.onerror=function(){this.onerror=null,this.src="/Images/fallback.jpg"}),t.addEventListener("click",()=>{window.location.href=`post.html?slug=${e.slug}`})}),""===t&&refreshPage()):renderNoResults(n)}function renderPagination(){const e=document.getElementById("pagination");if(e){e.innerHTML="";for(let t=1;t<=totalPages;t++){const o=document.createElement("button");o.textContent=t,o.className=t===currentPage?"pg-active":"",o?.addEventListener("click",()=>fetchPosts(t)),e.appendChild(o)}}}document.getElementById("categoryFilter")?.addEventListener("change",()=>{displayPosts("allPostsContainer")}),search.forEach(e=>e.addEventListener("keyup",searchPosts));const userIcon=document.querySelectorAll(".user-icon"),authModal=document.getElementById("authModal"),closeModal=document.getElementById("closeModal"),loginTab=document.getElementById("loginTab"),registerTab=document.getElementById("registerTab"),loginForm=document.getElementById("loginForm"),registerForm=document.getElementById("registerForm"),writePostBtns=document.querySelectorAll(".write-post"),userMenuDetails=document.getElementById("userMenuDetails"),logoutBtn=document.getElementById("logoutBtn");function logout(e=!1){localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.currentUser=null,updateUI(null),e||showToast("You have been logged out.","info")}async function checkUser(){if(!localStorage.getItem("token"))return updateUI(null),updateAvatar(null),null;try{const e=await apiFetch(`${AUTH_URL}/me`);if(!e.ok)throw new Error("Not authenticated");const t=normalizeUser((await e.json()).user);return localStorage.setItem("user",JSON.stringify(t)),window.currentUser=t,updateUI(t),updateAvatar(t),t}catch{return logout(!0),null}}function updateUI(e){e?.id?userIcon.forEach(t=>t.title=`Logged in as ${e.name}`):(userIcon.forEach(e=>e.title="Click to Login/Register"),userMenuDetails?.classList.remove("show"))}async function apiFetch(e,t={}){let o=localStorage.getItem("token");t.headers||(t.headers={}),o&&(t.headers.Authorization=`Bearer ${o}`);const n=e;let s=await fetch(n,{credentials:"include",...t});return 401===s.status&&(o=await refreshToken(),o&&(t.headers.Authorization=`Bearer ${o}`,s=await fetch(n,{credentials:"include",...t}))),s}async function refreshToken(){const e=localStorage.getItem("refreshToken");if(!e)return null;try{const t=await fetch(`${AUTH_URL}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})});if(!t.ok)throw new Error("Refresh failed");const o=await t.json();localStorage.setItem("token",o.token),o.refreshToken&&localStorage.setItem("refreshToken",o.refreshToken);const n=normalizeUser(o.user);return localStorage.setItem("user",JSON.stringify(n)),window.currentUser=n,updateUI(n),o.token}catch(e){return null}}function showToast(e,t="info",o=5e3){const n=document.getElementById("toast-container");if(!n)return;const s=document.createElement("div");s.className=`toast toast-${t}`;const a=document.createElement("i");a.className="success"===t?"fas fa-check-circle":"error"===t?"fas fa-exclamation-circle":"fas fa-info-circle",s.appendChild(a);const r=document.createElement("span");r.textContent=e,s.appendChild(r),n.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.5s forwards",s.addEventListener("animationend",()=>s.remove())},o)}async function handleLike(e){const t=e.dataset.postId,o=e.querySelector("i"),n=e.querySelector(".like-count"),s=e.closest(".post-interactions-container")?.querySelector(".liked-by"),a=e.classList.contains("liked"),r=localStorage.getItem("token"),i=localStorage.getItem("refreshToken");if(r||i)try{let r;r=a?await apiFetch(`/api/posts/${t}/unlike`,{method:"POST"}):await apiFetch(`/api/posts/${t}/like`,{method:"POST"});const i=await r.json();r.ok?(a?(e.classList.remove("liked"),o.className="fa-regular fa-heart"):(e.classList.add("liked"),o.className="fa-solid fa-heart"),n.textContent=i.likes??0,i.likedBy&&i.likedBy.length>0?1===i.likedBy.length?s.textContent=`Liked by ${i.likedBy[0]}`:s.textContent=`Liked by ${i.likedBy[0]} and ${i.likedBy.length-1} others`:s.textContent="No likes yet"):showToast(`Failed to update likes: ${i.message}`,"error")}catch(e){console.error("Like action failed:",e),showToast("Error updating like. Please try again.","error")}else showToast("Please log in to like or unlike posts.","error")}async function toggleComments(e){const t=e.dataset.postId;if(!t)return;const o=window.location.pathname.endsWith("post.html"),n=o?document.getElementById("singlePostContainer"):e.closest(".post");if(!n)return;const s=n.querySelector(".comments-section"),a=s?.querySelector(".comments-list");s&&a&&(o||s.classList.toggle("show"),(o||s.classList.contains("show"))&&await fetchComments(t,a))}async function handleDeleteComment(e){if("true"===e.dataset.deleting)return;e.dataset.deleting="true";const t=e.dataset.commentId;if(confirm("Are you sure you want to delete this comment?"))try{const o=await apiFetch(`${COMMENTS_URL}/${t}`,{method:"DELETE"}),n=await o.json();if(!o.ok)throw new Error(n.message||"Delete failed");{const t=e.closest(".comment");let o;if(t&&t.remove(),window.location.pathname.endsWith("post.html")){const e=document.getElementById("singlePostContainer");o=e?.querySelector(".comment-count")}else{const t=e.closest(".post");o=t?.querySelector(".comment-count")}if(o){const e=parseInt(o.textContent)||0;o.textContent=Math.max(0,e-1)}showToast("Comment deleted successfully!","success")}}catch(e){console.error("Error deleting comment:",e),showToast("Error deleting comment. Please try again.","error")}finally{e.dataset.deleting="false"}else e.dataset.deleting="false"}async function fetchComments(e,t,o=3){try{t.innerHTML='<p class="loading-comments">Loading comments...</p>';const n=await apiFetch(`${COMMENTS_URL}/post/${e}?_=${Date.now()}`);if(!n.ok)throw new Error("Failed to fetch comments");const s=await n.json();if(t.innerHTML="",0===s.length)return void(t.innerHTML="<p class='no-comments'>No comments yet. Be the first to comment!</p>");const a=s.slice(0,o);if(renderComments(a,t),s.length>o){const e=document.createElement("button");e.classList.add("view-more-btn"),e.textContent=`View all ${s.length} comments`;const o=document.createElement("div");o.classList.add("comments-scroll-container"),o.style.display="none",renderComments(s,o);let n=!1;e.addEventListener("click",()=>{n=!n,n?(t.innerHTML="",t.appendChild(o),t.appendChild(e),o.style.display="block",e.textContent="View less comments"):(t.innerHTML="",renderComments(a,t),e.textContent=`View all ${s.length} comments`,t.appendChild(e))}),t.appendChild(e)}}catch(e){console.error("Error fetching comments:",e),t.innerHTML="<p class='error-comments'>Failed to load comments.</p>"}}function renderComments(e,t){const o=window.currentUser?.id||window.currentUser?._id;e.forEach(e=>{const n=document.createElement("div");n.classList.add("comment");const s="object"==typeof e.authorId?e.authorId._id:e.authorId,a=o&&s&&s.toString()===o.toString();n.innerHTML=`\n      <div class="comment-header">\n        <p><strong class="comment-author" style="cursor: pointer;">${e.authorId?.name||"Anonymous"}:</strong> ${e.text}</p>\n        ${a?`<div class="comment-menu">\n                  <button class="menu-btn">â‹®</button>\n                  <div class="menu-options hidden">\n                    <button class="delete-comment-btn" data-comment-id="${e._id}">Delete</button>\n                  </div>\n                </div>`:""}\n      </div>  \n      <small>${new Date(e.createdAt).toLocaleString()}</small>\n    `,t.appendChild(n);const r=n.querySelector(".comment-author");r?.addEventListener("click",()=>{window.location.href=`profile.html?user=${e.authorId?.name}`})})}async function postComment(e,t,o,n){try{const s=localStorage.getItem("token"),a=await apiFetch(`${COMMENTS_URL}/post/${e}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({text:t})});if(!a.ok)throw new Error("Failed to post comment");{const t=await a.json(),s=document.createElement("div");s.classList.add("comment"),s.innerHTML=`\n        <div class="comment-header">\n          <p><strong>You:</strong> ${t.text}</p>\n          <div class="comment-menu">\n            <button class="menu-btn">â‹®</button>\n            <div class="menu-options hidden">\n              <button class="delete-comment-btn" data-comment-id="${t._id}">Delete</button>\n            </div>\n          </div>\n        </div>\n        <small>${new Date(t.createdAt).toLocaleString()}</small>\n      `,o.prepend(s),n&&await updateCommentCount(e,n),showToast("Comment posted successfully!","success")}}catch(e){console.error("Error posting comment:",e),showToast("Failed to post comment","error")}}async function updateCommentCount(e,t){try{const o=await apiFetch(`${COMMENTS_URL}/post/${e}`);if(!o.ok)throw new Error("Failed to fetch comment count");const n=(await o.json()).length;0===n?(t.textContent="0",t.title="No comments yet"):(t.textContent=n,t.title=`${n} comment${n>1?"s":""}`)}catch(e){console.error("Error fetching comment count:",e),t.textContent="0"}}function injectPostJsonLd(e){const t=document.getElementById("post-jsonld");t&&t.remove();const o={"@context":"https://schema.org","@type":"Article",headline:e.title,description:e.content.slice(0,160),image:e.image?[e.image]:[],author:{"@type":"Person",name:e.authorName||"BuzzInk Contributor"},publisher:{"@type":"Organization",name:"BuzzInk",logo:{"@type":"ImageObject",url:"https://buzzink.onrender.com/Images/logo.png"}},datePublished:e.createdAt||e.date,dateModified:e.updatedAt||e.date,mainEntityOfPage:{"@type":"WebPage","@id":window.location.href}},n=document.createElement("script");n.type="application/ld+json",n.id="post-jsonld",n.textContent=JSON.stringify(o),document.head.appendChild(n)}async function loadSinglePost(){const e=new URLSearchParams(window.location.search).get("slug");if(e)try{const t=await apiFetch(`${API_URL}/${e}`);if(!t.ok)throw new Error("Failed to fetch post");const o=await t.json(),n=window.currentUser?._id||window.currentUser?.id,s="object"==typeof o.authorId&&null!==o.authorId?o.authorId._id:o.authorId,a=n&&String(s)===String(n),r=document.getElementById("singlePostContainer");r.innerHTML=`\n      ${o.image?`<img src="${getImageUrl(o.image)}" alt="${o.title}" class="post-image" loading="lazy">`:""}\n      <h1>${o.title}</h1>\n      <p class="tag">${o.category}</p>\n      <p onclick="window.location.href='profile.html?user=${o.authorId}'" style="cursor: pointer;"><em>By ${o.authorName||"Unknown"}</em></p>\n      <small>${new Date(o.date).toLocaleString()}</small>\n      <div class="content">\n        <p>${o.content}</p>\n      </div>\n      <div class="post-interactions-container">\n        <div class="post-interactions">\n          <button class="like-btn ${o.likedByUser?"liked":""}" data-post-id="${o._id}">\n            <i class="${o.likedByUser?"fa-solid":"fa-regular"} fa-heart"></i>\n            <span class="like-count">${o.likesCount||0}</span>\n          </button>\n          <button class="comment-btn" data-post-id="${o._id}">\n            <i class="fa-regular fa-comment"></i>\n            <span class="comment-count">${o.commentsCount||0}</span>\n          </button>\n          <button class="share-btn">\n            <i class="fa-solid fa-share"></i>\n            <span class="share-count"></span>\n          </button>\n        </div>\n        <span class="liked-by likes-info">No likes yet</span>\n      </div>\n      <div class="comments-section show">\n        <form class="comment-form">\n          <input type="text" class="comment-input" placeholder="Write a comment..." required />\n          <button type="submit">Comment</button>\n        </form>\n        <div class="comments-list"></div>\n      </div>\n      ${a?`\n      <div class="post-actions">\n        <button class="edit-btn btn" data-slug="${o.slug}">Edit</button>\n        <button class="delete-btn btn" data-slug="${o.slug}">Delete</button>\n      </div>`:""}\n    `;const i=r.querySelector(".post-image");i&&(i.onerror=function(){this.onerror=null,this.src="/Images/fallback.jpg"});const l=r?.querySelector(".like-btn"),c=l?.querySelector("i"),d=r?.querySelector(".liked-by"),m=Array.isArray(o.likes)?o.likes.map(e=>"object"==typeof e?e._id:e):[];n&&(m.includes(n)||o.likedByUser)?(l.classList.add("liked"),c.className="fa-solid fa-heart"):(l.classList.remove("liked"),c.className="fa-regular fa-heart"),o.likedBy&&0!==o.likedBy.length?1===o.likedBy.length?d.textContent=`Liked by ${o.likedBy[0]}`:d.textContent=`Liked by ${o.likedBy[0]} and ${o.likedBy.length-1} others`:d.textContent="No likes yet";const u=r.querySelector(".comment-count");updateCommentCount(o._id,u);const g=document.querySelector(".comments-section"),h=g.querySelector(".comments-list");g&&h&&await fetchComments(o._id,h,1/0),injectPostJsonLd(o)}catch(e){console.error(e),document.getElementById("singlePostContainer").innerHTML="<p>Error loading post.</p>"}}userIcon.forEach(e=>e?.addEventListener("click",()=>{const e=localStorage.getItem("user"),t=e?JSON.parse(e):null;t&&t.id?(userMenuDetails.classList.toggle("show"),authModal.classList.add("hidden")):(userMenuDetails.classList.add("hidden"),authModal.classList.remove("hidden"),loginTab.classList.add("active"),registerTab.classList.remove("active"),loginForm.classList.remove("hidden"),registerForm.classList.add("hidden"),loginForm?.reset(),registerForm?.reset())})),document.addEventListener("click",e=>{!userMenuDetails?.classList.contains("show")||userMenuDetails.contains(e.target)||[...userIcon].some(t=>t.contains(e.target))||userMenuDetails.classList.remove("show"),!mobileMenu?.classList.contains("active")||mobileMenu.contains(e.target)||menuToggle.contains(e.target)||mobileMenu.classList.remove("active")}),closeModal?.addEventListener("click",()=>{authModal.classList.add("hidden")}),loginTab?.addEventListener("click",()=>{loginForm.classList.remove("hidden"),registerForm.classList.add("hidden"),loginTab.classList.add("active"),registerTab.classList.remove("active")}),registerTab?.addEventListener("click",()=>{registerForm.classList.remove("hidden"),loginForm.classList.add("hidden"),registerTab.classList.add("active"),loginTab.classList.remove("active")}),writePostBtns.forEach(e=>{e.addEventListener("click",e=>{const t=localStorage.getItem("user"),o=t?JSON.parse(t):null;o&&o.id?(localStorage.removeItem("editSlug"),window.location.href="write.html"):(e.preventDefault(),authModal.classList.remove("hidden"),loginTab.classList.add("active"),registerTab.classList.remove("active"),loginForm.classList.remove("hidden"),registerForm.classList.add("hidden"))})}),loginForm?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("loginEmail").value,o=document.getElementById("loginPassword").value;console.log("Login Triggered");const n=await apiFetch(`${AUTH_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:o})}),s=await n.json();console.log("Login response:",s),n.ok||showToast(`Login failed: ${s.message||"Unknown error"}`,"error");const a=normalizeUser(s.user);localStorage.setItem("token",s.token),localStorage.setItem("refreshToken",s.refreshToken),localStorage.setItem("user",JSON.stringify(a)),window.currentUser=a,localStorage.setItem("role",a.role),"admin"===a.role&&(window.location.href="admin.html"),updateUI(a),updateAvatar(a),authModal.classList.add("hidden"),loginForm.reset(),showToast(`Welcome back, ${a.name}!`,"success"),refreshPage()}),registerForm?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("registerName").value,o=document.getElementById("registerEmail").value,n=document.getElementById("registerPassword").value,s=await apiFetch(`${AUTH_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,email:o,password:n})}),a=await s.json();console.log("Register response:",a),s.ok||showToast(`Registration failed: ${a.message||"Unknown error"}`,"error");const r=normalizeUser(a.user);localStorage.setItem("token",a.token),localStorage.setItem("refreshToken",a.refreshToken),localStorage.setItem("user",JSON.stringify(r)),window.currentUser=r,localStorage.setItem("role",r.role),updateUI(r),updateAvatar(r),authModal.classList.add("hidden"),registerForm.reset(),showToast(`Welcome, ${r.name}! Your account has been created.`,"success")}),logoutBtn?.addEventListener("click",()=>{logout(),window.location.href="index.html"}),document.addEventListener("click",async e=>{const t=e.target.closest(".edit-btn");if(t)return e.preventDefault(),e.stopPropagation(),void editPost(t.dataset.slug);const o=e.target.closest(".delete-btn");if(o)return e.preventDefault(),e.stopPropagation(),void deletePost(o.dataset.slug);const n=e.target.closest(".like-btn");if(n)return e.preventDefault(),void handleLike(n);const s=e.target.closest(".comment-btn");if(s)return e.preventDefault(),void toggleComments(s);const a=e.target.closest(".delete-comment-btn");a&&(e.preventDefault(),e.stopPropagation(),handleDeleteComment(a));const r=e.target.closest(".menu-btn"),i=e.target.closest(".menu-options");if(r||i){if(r){r.nextElementSibling.classList.toggle("hidden")}}else document.querySelectorAll(".menu-options").forEach(e=>e.classList.add("hidden"))}),document.addEventListener("submit",async e=>{const t=e.target.closest(".comment-form");if(!t)return;e.preventDefault();const o=t.querySelector(".comment-input"),n=o.value.trim();if(!n)return;let s,a,r,i;if(window.location.pathname.endsWith("post.html")?(s=document.getElementById("singlePostContainer"),a=s.querySelector(".comments-list"),r=s.querySelector(".comment-btn").dataset.postId,i=s.querySelector(".comment-count")):(s=t.closest(".post"),a=s.querySelector(".comments-list"),r=s.querySelector(".like-btn").dataset.postId,i=s.querySelector(".comment-count")),!window.currentUser||!localStorage.getItem("token"))return showToast("Please log in to comment.","error"),void(o.value="");await postComment(r,n,a,i),o.value=""});const fetchTrendingPosts=async()=>{const e=await apiFetch(`${API_URL}/trending?limit=5`),t=await e.json();document.getElementById("trending-list").innerHTML=t.map((e,t)=>`\n    <li>\n      <span class="trending-rank">${["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][t]||`#${t+1}`}</span>\n      <a href="post.html?slug=${e.slug}" class="trending-title">${e.title}</a>\n      <i class="fa-solid fa-bolt trending-icon" title="Trending now"></i>\n    </li>\n  `).join("")},profileEdit=document.getElementById("profile-edit");function initForgotPassword(){const e=document.getElementById("forgotPasswordLink"),t=document.getElementById("forgotPasswordModal"),o=document.getElementById("closeForgotModal"),n=document.getElementById("forgotPasswordForm");e&&e.addEventListener("click",e=>{e.preventDefault(),t.classList.remove("hidden")}),o&&o.addEventListener("click",()=>{t.classList.add("hidden")}),n&&n.addEventListener("submit",async e=>{e.preventDefault();const o=document.getElementById("forgotEmail").value.trim();try{const e=await fetch("/api/auth/forgot-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o})});showToast((await e.json()).message||"Check your email for the reset link.","success"),t.classList.add("hidden")}catch(e){console.error(e),showToast("Failed to send reset link. Try again.","error")}})}profileEdit?.addEventListener("click",()=>{window.location.href="dashboard.html"}),document.addEventListener("DOMContentLoaded",async()=>{const e=await checkUser();window.currentUser=e,await updateAvatar(e),initForgotPassword(),window.location.pathname.endsWith("index.html")?(fetchPosts(),fetchTrendingPosts()):window.location.pathname.endsWith("my-posts.html")?fetchMyPosts():window.location.pathname.endsWith("post.html")?loadSinglePost():fetchPosts(),refreshPage()});export{showToast,apiFetch};