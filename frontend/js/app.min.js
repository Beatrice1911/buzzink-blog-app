const API_BASE="https://buzzink.onrender.com",API_URL="/api/posts",AUTH_URL="/api/auth",COMMENTS_URL="/api/comments",menuToggle=document.querySelector(".menu-toggle"),mobileMenu=document.getElementById("mobileMenu"),searchIcon=document.querySelector(".search-icon"),mobileSearch=document.getElementById("mobileSearch"),logo=document.querySelector(".logo"),allPostsBtn=document.querySelector(".all-posts-btn"),myPosts=document.getElementById("myPosts"),search=document.querySelectorAll(".search"),postImages=document.querySelectorAll(".post-image");function normalizeUser(e){return e?{...e,id:e.id||e._id}:null}window.currentUser=(()=>{const e=localStorage.getItem("user");return e?normalizeUser(JSON.parse(e)):null})(),logo?.addEventListener("click",()=>{window.location.href="index.html"}),allPostsBtn?.addEventListener("click",()=>{window.location.href="all-posts.html"}),myPosts?.addEventListener("click",()=>{window.location.href="my-posts.html"}),searchIcon?.addEventListener("click",()=>{mobileSearch.classList.toggle("show"),mobileSearch.classList.contains("show")&&mobileSearch.querySelector("input").focus()}),menuToggle?.addEventListener("click",e=>{e.stopPropagation(),userMenuDetails.classList.contains("show")&&userMenuDetails.classList.remove("show"),mobileMenu.classList.toggle("active")}),window.location.pathname.endsWith("write.html")&&!localStorage.getItem("editId")&&localStorage.removeItem("editId");let posts=[],currentPage=1,totalPages=1;function renderNoResults(e){e.innerHTML='<p style="text-align:center; color:gray; font-size: 20px; font-weight: bold;">No results found...</p>'}function renderNoAuthorPost(e){e.innerHTML='<p style="text-align:center; color:gray; font-size: 20px; font-weight: bold;">You haven\'t made any posts yet...</p>'}function getImageUrl(e){return e?e.startsWith("http")?e:(e.startsWith("/uploads"),"/images/fallback.jpg"):"/images/fallback.jpg"}async function fetchPosts(e=1,t=6){try{const n=await apiFetch(`${API_URL}?page=${e}&limit=${t}`),o=await n.json();posts=o.posts,currentPage=o.currentPage,totalPages=o.totalPages,refreshPage(),renderPagination()}catch(e){console.error("Error fetching posts:",e),showToast("Failed to load posts!","error")}}async function fetchMyPosts(e=1,t=6){try{const n=await apiFetch(`${API_URL}/mine?page=${e}&limit=${t}`);if(!n.ok){const e=await n.text();throw new Error(e||"Failed to fetch your posts")}const o=await n.json();posts=o.posts||[],currentPage=o.currentPage||1,totalPages=o.totalPages||1;if(displayPosts("myPostsContainer"),renderPagination(),0===posts.length){const e=document.getElementById("myPostsContainer");e&&renderNoAuthorPost(e)}}catch(e){console.error("Error fetching my posts:",e),showToast("Failed to load your posts!","error")}}function displayPosts(e,t=null){const n=window.currentUser?._id||window.currentUser?.id,o=document.getElementById(e);if(!o)return;o.innerHTML="";let s=[...posts];if("allPostsContainer"===e){const e=document.getElementById("categoryFilter");if(e){const t=e?.value;"all"!==t&&(s=s.filter(e=>e.category===t))}}"myPostsContainer"===e&&n&&(s=s.filter(e=>{const t="object"==typeof e.authorId&&null!==e.authorId?e.authorId._id:e.authorId;return String(t)===String(n)})),t&&(s=s.slice(0,t)),0!==s.length?s.forEach(e=>{const t=document.createElement("div");t.classList.add("post");const s=e.content.length>150?e.content.substring(0,150)+"...":e.content,a="object"==typeof e.authorId&&null!==e.authorId?e.authorId._id:e.authorId,r=n&&String(a)===String(n);if(t.innerHTML=`\n      ${e.image?`<a href="post.html?id=${e._id}">\n             <img src="${getImageUrl(e.image)}" alt="${e.title}" class="post-image">\n           </a>`:""}\n        <p class="tag">${e.category}</p>\n        <h2>\n          <a href="post.html?id=${e._id}" class="post-link">${e.title}</a>\n        </h2>\n        <p>${s} <a href="post.html?id=${e._id}" class="read-more">Read more</a></p>\n        <a href="profile.html?user=${e.authorName}" class="author"><em>By ${e.authorName||"Unknown"}</em></a>\n        <small>${new Date(e.date).toLocaleString()}</small>\n        <br>\n        <div class="post-interactions-container">\n          <div class="post-interactions">\n            <button class="like-btn ${e.likedByUser?"liked":""}" data-post-id="${e._id}">\n              <i class="${e.likedByUser?"fa-solid":"fa-regular"} fa-heart"></i>\n              <span class="like-count">${e.likesCount||0}</span>\n            </button>\n            <button class="comment-btn">\n              <i class="fa-regular fa-comment"></i>\n              <span class="comment-count">${e.commentsCount||0}</span>\n            </button>\n            <button class="share-btn">\n              <i class="fa-solid fa-share"></i>\n              <span class="share-count"></span>\n            </button>\n          </div>\n          <span class="liked-by likes-info">No likes yet</span>\n        </div>\n        <div class="comments-section">\n          <form class="comment-form">\n            <input type="text" class="comment-input" placeholder="Write a comment..." required />\n            <button type="submit">Comment</button>\n          </form>\n          <div class="comments-list"></div>\n        </div>\n        ${r?'\n        <div class="post-actions">\n            <button class="edit-btn btn">Edit</button>\n            <button class="delete-btn btn">Delete</button>\n        </div>\n        ':""}\n    `,o.appendChild(t),r){const n=t.querySelector(".edit-btn"),o=t.querySelector(".delete-btn");n?.addEventListener("click",()=>editPost(e._id)),o?.addEventListener("click",()=>deletePost(e._id))}const i=t.querySelector(".post-image");i&&(i.onerror=function(){this.onerror=null,this.src="/images/fallback.jpg"});const l=t.querySelector(".like-btn"),c=l.querySelector("i"),d=t.querySelector(".liked-by"),m=Array.isArray(e.likes)?e.likes.map(e=>"object"==typeof e?e._id:e):[];n&&(m.includes(n)||e.likedByUser)?(l.classList.add("liked"),c.className="fa-solid fa-heart"):(l.classList.remove("liked"),c.className="fa-regular fa-heart"),e.likedBy&&0!==e.likedBy.length?1===e.likedBy.length?d.textContent=`Liked by ${e.likedBy[0]}`:d.textContent=`Liked by ${e.likedBy[0]} and ${e.likedBy.length-1} others`:d.textContent="No likes yet";const u=t.querySelector(".comment-count");updateCommentCount(e._id,u)}):renderNoResults(o)}async function addPost(e,t,n,o){const s=new FormData;s.append("title",e),s.append("content",t),s.append("category",n),o&&s.append("image",o);const a=await apiFetch(`${API_URL}`,{method:"POST",body:s,credentials:"include"});if(!a.ok)throw new Error("Failed to add post");return await a.json()}async function deletePost(e){if(confirm("Are you sure you want to delete this post?"))try{const t=await apiFetch(`${API_URL}/${e}`,{method:"DELETE"});if(!t.ok){const e=await t.text();throw new Error(e||"Failed to delete post")}showToast("Post deleted successfully!","success"),window.location.pathname.endsWith("my-posts.html")?fetchMyPosts(currentPage):fetchPosts(currentPage)}catch(e){console.error("Error deleting post:",e),showToast("Failed to delete post!","error")}}function editPost(e){localStorage.removeItem("editId"),localStorage.setItem("editId",e),window.location.href="write.html"}const postForm=document.getElementById("postForm");if(postForm){const e=localStorage.getItem("editId");e&&"null"!==e?((async()=>{try{const t=await apiFetch(`${API_URL}/${e}`);if(!t.ok)throw new Error("Post not found");const n=await t.json();if(document.getElementById("title").value=n.title||"",document.getElementById("content").value=n.content||"",document.getElementById("category").value=n.category||"",n.image){const e=document.getElementById("imagePreview");e.src=getImageUrl(n.image),e.style.display="block"}}catch(e){console.error("Error loading post:",e)}})(),postForm.onsubmit=async function(t){t.preventDefault();const n=new FormData;n.append("title",document.getElementById("title").value),n.append("content",document.getElementById("content").value),n.append("category",document.getElementById("category").value);const o=document.getElementById("image").files[0];o&&n.append("image",o);try{const t=await apiFetch(`${API_URL}/${e}`,{method:"PUT",body:n});t.ok?(showToast("Post updated successfully!","success"),localStorage.removeItem("editId"),window.location.href="all-posts.html"):console.error("Update failed:",await t.text())}catch(e){console.error("Error updating post:",e),showToast("Failed to update post!","error")}}):(localStorage.removeItem("editId"),postForm?.addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("title").value,n=document.getElementById("content").value,o=document.getElementById("category").value,s=document.getElementById("image").files[0];console.log("Submitting new post:",{title:t,content:n,category:o,imageFile:s});try{const e=await addPost(t,n,o,s);console.log("Post created successfully!",e),showToast("Post created successfully!","success"),postForm.reset(),window.location.href="all-posts.html",localStorage.removeItem("editId")}catch(e){console.error("Error adding post:",e),showToast("Failed to add post!","error")}}))}function refreshPage(){document.getElementById("allPostsContainer")&&displayPosts("allPostsContainer"),document.getElementById("featuredPostsContainer")&&displayPosts("featuredPostsContainer",3)}function searchPosts(e){const t=e.target.value.toLowerCase()||"",n=document.getElementById("allPostsContainer")?"allPostsContainer":"featuredPostsContainer",o=document.getElementById(n);if(!o)return;const s=posts.filter(e=>e.title.toLowerCase().includes(t)||e.content.toLowerCase().includes(t)||e.category.toLowerCase().includes(t));o.innerHTML="",0!==s.length?(s.forEach(e=>{const t=document.createElement("div");t.classList.add("post"),t.innerHTML=`\n      ${e.image?`<img src="${getImageUrl(e.image)}" alt="${e.title}" class="post-image">`:""}\n      <div class="post-content">\n        <p class="tag">${e.category}</p>\n        <h2>${e.title}</h2>\n        <p>${e.content}</p>\n        <p><em>By ${e.authorName||"Unknown"}</em></p>\n        <small>${new Date(e.date).toLocaleString()}</small>\n      </div>\n    `,o.appendChild(t);const n=t.querySelector(".post-image");n&&(n.onerror=function(){this.onerror=null,this.src="/images/fallback.jpg"}),t.addEventListener("click",()=>{window.location.href=`post.html?id=${e._id}`})}),""===t&&refreshPage()):renderNoResults(o)}function renderPagination(){const e=document.getElementById("pagination");if(e){e.innerHTML="";for(let t=1;t<=totalPages;t++){const n=document.createElement("button");n.textContent=t,n.className=t===currentPage?"pg-active":"",n?.addEventListener("click",()=>fetchPosts(t)),e.appendChild(n)}}}document.getElementById("categoryFilter")?.addEventListener("change",()=>{displayPosts("allPostsContainer")}),search.forEach(e=>e.addEventListener("keyup",searchPosts));const userIcon=document.querySelectorAll(".user-icon"),authModal=document.getElementById("authModal"),closeModal=document.getElementById("closeModal"),loginTab=document.getElementById("loginTab"),registerTab=document.getElementById("registerTab"),loginForm=document.getElementById("loginForm"),registerForm=document.getElementById("registerForm"),writePostBtns=document.querySelectorAll(".write-post"),userMenuDetails=document.getElementById("userMenuDetails"),logoutBtn=document.getElementById("logoutBtn");function logout(e=!1){localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.currentUser=null,updateUI(null),e||showToast("You have been logged out.","info")}async function checkUser(){if(!localStorage.getItem("token"))return updateUI(null),null;try{const e=await apiFetch(`${AUTH_URL}/me`);if(!e.ok)throw new Error("Not authenticated");const t=normalizeUser((await e.json()).user);return localStorage.setItem("user",JSON.stringify(t)),window.currentUser=t,updateUI(t),t}catch{return logout(!0),null}}function updateUI(e){e?.id?userIcon.forEach(t=>t.title=`Logged in as ${e.name}`):(userIcon.forEach(e=>e.title="Click to Login/Register"),userMenuDetails?.classList.remove("show"))}async function apiFetch(e,t={}){let n=localStorage.getItem("token");t.headers||(t.headers={}),n&&(t.headers.Authorization=`Bearer ${n}`);const o=e;let s=await fetch(o,{credentials:"include",...t});return 401===s.status&&(n=await refreshToken(),n&&(t.headers.Authorization=`Bearer ${n}`,s=await fetch(o,{credentials:"include",...t}))),s}async function refreshToken(){const e=localStorage.getItem("refreshToken");if(!e)return null;try{const t=await fetch(`${AUTH_URL}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})});if(!t.ok)throw new Error("Refresh failed");const n=await t.json();localStorage.setItem("token",n.token),n.refreshToken&&localStorage.setItem("refreshToken",n.refreshToken);const o=normalizeUser(n.user);return localStorage.setItem("user",JSON.stringify(o)),window.currentUser=o,updateUI(o),n.token}catch(e){return null}}function showToast(e,t="info",n=5e3){const o=document.getElementById("toast-container");if(!o)return;const s=document.createElement("div");s.className=`toast toast-${t}`;const a=document.createElement("i");a.className="success"===t?"fas fa-check-circle":"error"===t?"fas fa-exclamation-circle":"fas fa-info-circle",s.appendChild(a);const r=document.createElement("span");r.textContent=e,s.appendChild(r),o.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.5s forwards",s.addEventListener("animationend",()=>s.remove())},n)}async function fetchComments(e,t,n=3){try{t.innerHTML='<p class="loading-comments">Loading comments...</p>';const o=await apiFetch(`${COMMENTS_URL}/${e}`);if(!o.ok)throw new Error("Failed to fetch comments");const s=await o.json();if(t.innerHTML="",0===s.length)return void(t.innerHTML="<p class='no-comments'>No comments yet. Be the first to comment!</p>");const a=s.slice(0,n);if(renderComments(a,t),s.length>n){const e=document.createElement("button");e.classList.add("view-more-btn"),e.textContent=`View all ${s.length} comments`;const n=document.createElement("div");n.classList.add("comments-scroll-container"),n.style.display="none",renderComments(s,n);let o=!1;e.addEventListener("click",()=>{o=!o,o?(t.innerHTML="",t.appendChild(n),t.appendChild(e),n.style.display="block",e.textContent="View less comments"):(t.innerHTML="",renderComments(a,t),e.textContent=`View all ${s.length} comments`,t.appendChild(e))}),t.appendChild(e)}}catch(e){console.error("Error fetching comments:",e),t.innerHTML="<p class='error-comments'>Failed to load comments.</p>"}}function renderComments(e,t){const n=window.currentUser?.id||window.currentUser?._id;e.forEach(e=>{const o=document.createElement("div");o.classList.add("comment");const s="object"==typeof e.authorId?e.authorId._id:e.authorId,a=n&&s&&s.toString()===n.toString();o.innerHTML=`\n      <div class="comment-header">\n        <p><strong class="comment-author" style="cursor: pointer;">${e.authorId?.name||"Anonymous"}:</strong> ${e.text}</p>\n        ${a?`<div class="comment-menu">\n                  <button class="menu-btn">â‹®</button>\n                  <div class="menu-options hidden">\n                    <button class="delete-comment-btn" data-comment-id="${e._id}">Delete</button>\n                  </div>\n                </div>`:""}\n      </div>  \n      <small>${new Date(e.createdAt).toLocaleString()}</small>\n    `,t.appendChild(o);const r=document.querySelector(".comment-author");r?.addEventListener("click",()=>{window.location.href=`profile.html?user=${e.authorId?.name}`})})}async function postComment(e,t,n){try{const o=localStorage.getItem("token"),s=await apiFetch(`${COMMENTS_URL}/${e}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({text:t})});if(!s.ok)throw new Error("Failed to post comment");{const e=await s.json(),t=document.createElement("div");t.classList.add("comment"),t.innerHTML=`\n        <div class="comment-header">\n          <p><strong>You:</strong> ${e.text}</p>\n          <div class="comment-menu">\n            <button class="menu-btn">â‹®</button>\n            <div class="menu-options hidden">\n              <button class="delete-comment-btn" data-comment-id="${e._id}">Delete</button>\n            </div>\n          </div>\n        </div>\n        <small>${new Date(e.createdAt).toLocaleString()}</small>\n      `,n.prepend(t),showToast("Comment posted successfully!","success")}}catch(e){console.error("Error posting comment:",e),showToast("Failed to post comment","error")}}async function updateCommentCount(e,t){try{const n=await apiFetch(`${COMMENTS_URL}/${e}`);if(!n.ok)throw new Error("Failed to fetch comment count");const o=(await n.json()).length;0===o?(t.textContent="0",t.title="No comments yet"):(t.textContent=o,t.title=`${o} comment${o>1?"s":""}`)}catch(e){console.error("Error fetching comment count:",e),t.textContent="0"}}async function loadSinglePost(){const e=new URLSearchParams(window.location.search).get("id");if(e)try{const t=await apiFetch(`${API_URL}/${e}`);if(!t.ok)throw new Error("Failed to fetch post");const n=await t.json(),o=window.currentUser?._id||window.currentUser?.id,s="object"==typeof n.authorId&&null!==n.authorId?n.authorId._id:n.authorId,a=o&&String(s)===String(o),r=document.getElementById("singlePostContainer");r.innerHTML=`\n      ${n.image?`<img src="${getImageUrl(n.image)}" alt="${n.title}" class="post-image">`:""}\n      <h1>${n.title}</h1>\n      <p class="tag">${n.category}</p>\n      <p onclick="window.location.href='profile.html?user=${n.authorName}'" style="cursor: pointer;"><em>By ${n.authorName||"Unknown"}</em></p>\n      <small>${new Date(n.date).toLocaleString()}</small>\n      <div class="content">\n        <p>${n.content}</p>\n      </div>\n      <div class="post-interactions-container">\n        <div class="post-interactions">\n          <button class="like-btn ${n.likedByUser?"liked":""}" data-post-id="${n._id}">\n            <i class="${n.likedByUser?"fa-solid":"fa-regular"} fa-heart"></i>\n            <span class="like-count">${n.likesCount||0}</span>\n          </button>\n          <button class="comment-btn">\n            <i class="fa-regular fa-comment"></i>\n            <span class="comment-count">${n.commentsCount||0}</span>\n          </button>\n          <button class="share-btn">\n            <i class="fa-solid fa-share"></i>\n            <span class="share-count"></span>\n          </button>\n        </div>\n        <span class="liked-by likes-info">No likes yet</span>\n      </div>\n      <div class="comments-section show">\n        <form class="comment-form">\n          <input type="text" class="comment-input" placeholder="Write a comment..." required />\n          <button type="submit">Comment</button>\n        </form>\n        <div class="comments-list"></div>\n      </div>\n      ${a?'\n      <div class="post-actions">\n        <button class="edit-btn btn">Edit</button>\n        <button class="delete-btn btn">Delete</button>\n      </div>':""}\n    `;const i=r.querySelector(".edit-btn"),l=r.querySelector(".delete-btn");a&&(i?.addEventListener("click",()=>editPost(n._id)),l?.addEventListener("click",()=>deletePost(n._id)));const c=r.querySelector(".post-image");c&&(c.onerror=function(){this.onerror=null,this.src="/images/fallback.jpg"});const d=r?.querySelector(".like-btn"),m=d?.querySelector("i"),u=r?.querySelector(".liked-by"),g=Array.isArray(n.likes)?n.likes.map(e=>"object"==typeof e?e._id:e):[];o&&(g.includes(o)||n.likedByUser)?(d.classList.add("liked"),m.className="fa-solid fa-heart"):(d.classList.remove("liked"),m.className="fa-regular fa-heart"),n.likedBy&&0!==n.likedBy.length?1===n.likedBy.length?u.textContent=`Liked by ${n.likedBy[0]}`:u.textContent=`Liked by ${n.likedBy[0]} and ${n.likedBy.length-1} others`:u.textContent="No likes yet";const h=r.querySelector(".comment-count");updateCommentCount(n._id,h);const p=document.querySelector(".comments-section"),y=p.querySelector(".comments-list");p&&y&&await fetchComments(n._id,y,1/0)}catch(e){console.error(e),document.getElementById("singlePostContainer").innerHTML="<p>Error loading post.</p>"}}userIcon.forEach(e=>e?.addEventListener("click",()=>{const e=localStorage.getItem("user"),t=e?JSON.parse(e):null;t&&t.id?(userMenuDetails.classList.toggle("show"),authModal.classList.add("hidden")):(userMenuDetails.classList.add("hidden"),authModal.classList.remove("hidden"),loginTab.classList.add("active"),registerTab.classList.remove("active"),loginForm.classList.remove("hidden"),registerForm.classList.add("hidden"),loginForm?.reset(),registerForm?.reset())})),document.addEventListener("click",e=>{!userMenuDetails?.classList.contains("show")||userMenuDetails.contains(e.target)||[...userIcon].some(t=>t.contains(e.target))||userMenuDetails.classList.remove("show"),!mobileMenu?.classList.contains("active")||mobileMenu.contains(e.target)||menuToggle.contains(e.target)||mobileMenu.classList.remove("active")}),closeModal?.addEventListener("click",()=>{authModal.classList.add("hidden")}),loginTab?.addEventListener("click",()=>{loginForm.classList.remove("hidden"),registerForm.classList.add("hidden"),loginTab.classList.add("active"),registerTab.classList.remove("active")}),registerTab?.addEventListener("click",()=>{registerForm.classList.remove("hidden"),loginForm.classList.add("hidden"),registerTab.classList.add("active"),loginTab.classList.remove("active")}),writePostBtns.forEach(e=>{e.addEventListener("click",e=>{const t=localStorage.getItem("user"),n=t?JSON.parse(t):null;n&&n.id?(localStorage.removeItem("editId"),window.location.href="write.html"):(e.preventDefault(),authModal.classList.remove("hidden"),loginTab.classList.add("active"),registerTab.classList.remove("active"),loginForm.classList.remove("hidden"),registerForm.classList.add("hidden"))})}),loginForm?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("loginEmail").value,n=document.getElementById("loginPassword").value;console.log("Login Triggered");const o=await apiFetch(`${AUTH_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:n})}),s=await o.json();console.log("Login response:",s),o.ok||showToast(`Login failed: ${s.message||"Unknown error"}`,"error");const a=normalizeUser(s.user);localStorage.setItem("token",s.token),localStorage.setItem("refreshToken",s.refreshToken),localStorage.setItem("user",JSON.stringify(a)),window.currentUser=a,updateUI(a),authModal.classList.add("hidden"),loginForm.reset(),showToast(`Welcome back, ${a.name}!`,"success"),refreshPage()}),registerForm?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("registerName").value,n=document.getElementById("registerEmail").value,o=document.getElementById("registerPassword").value,s=await apiFetch(`${AUTH_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,email:n,password:o})}),a=await s.json();console.log("Register response:",a),s.ok||showToast(`Registration failed: ${a.message||"Unknown error"}`,"error");const r=normalizeUser(a.user);localStorage.setItem("token",a.token),localStorage.setItem("refreshToken",a.refreshToken),localStorage.setItem("user",JSON.stringify(r)),window.currentUser=r,updateUI(r),authModal.classList.add("hidden"),registerForm.reset(),showToast(`Welcome, ${r.name}! Your account has been created.`,"success")}),logoutBtn?.addEventListener("click",()=>{logout(),window.location.href="index.html"}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",async e=>{const t=e.target.closest(".like-btn");if(!t)return;e.preventDefault();const n=t.dataset.postId,o=t.querySelector("i"),s=t.querySelector(".like-count"),a=t.closest(".post-interactions-container")?.querySelector(".liked-by"),r=t.classList.contains("liked"),i=localStorage.getItem("token"),l=localStorage.getItem("refreshToken");if(i||l)try{let e;e=r?await apiFetch(`/api/posts/${n}/unlike`,{method:"POST"}):await apiFetch(`/api/posts/${n}/like`,{method:"POST"});const i=await e.json();e.ok?(r?(t.classList.remove("liked"),o.className="fa-regular fa-heart"):(t.classList.add("liked"),o.className="fa-solid fa-heart"),s.textContent=i.likes??0,i.likedBy&&i.likedBy.length>0?1===i.likedBy.length?a.textContent=`Liked by ${i.likedBy[0]}`:a.textContent=`Liked by ${i.likedBy[0]} and ${i.likedBy.length-1} others`:a.textContent="No likes yet"):showToast(`Failed to update likes: ${i.message}`,"error")}catch(e){console.error("Like action failed:",e),showToast("Error updating like. Please try again.","error")}else showToast("Please log in to like or unlike posts.","error")}),document.addEventListener("click",async e=>{if(window.location.pathname.endsWith("post.html"))return;const t=e.target.closest(".comment-btn");if(t){e.preventDefault();const n=t.closest(".post"),o=n.querySelector(".comments-section"),s=o.querySelector(".comments-list"),a=n.querySelector(".like-btn").dataset.postId;o.classList.toggle("show"),o.classList.contains("show")&&await fetchComments(a,s)}}),document.addEventListener("submit",async e=>{if(e.target.closest(".comment-form")){e.preventDefault();const t=e.target,n=t.querySelector(".comment-input"),o=n.value.trim();if(!o)return;const s=t.closest(".post"),a=s.querySelector(".comments-list"),r=s.querySelector(".like-btn").dataset.postId;if(!window.currentUser||!localStorage.getItem("token"))return showToast("Please log in to comment.","error"),void(n.value="");await postComment(r,o,a),n.value="";const i=s.querySelector(".comment-count");await updateCommentCount(r,i)}}),document.addEventListener("click",e=>{const t=e.target.closest(".menu-btn"),n=e.target.closest(".menu-options");if(t||n){if(t){t.nextElementSibling.classList.toggle("hidden")}}else document.querySelectorAll(".menu-options").forEach(e=>e.classList.add("hidden"))}),document.addEventListener("click",async e=>{const t=e.target.closest(".delete-comment-btn");if(t){if(e.preventDefault(),e.stopPropagation(),"true"===t.dataset.deleting)return;t.dataset.deleting="true";const n=t.dataset.commentId;if(!confirm("Are you sure you want to delete this comment?"))return;try{const e=localStorage.getItem("token"),o=await apiFetch(`${COMMENTS_URL}/${n}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}}),s=await o.json();if(!o.ok)throw new Error(s.message||"Delete failed");{const e=t.closest(".comment"),n=t.closest(".post").querySelector(".comment-count");e.remove();const o=parseInt(n.textContent)||0;n.textContent=Math.max(0,o-1),showToast("Comment deleted successfully.","success")}}catch(e){console.error("Error deleting comment:",e),showToast("Error deleting comment. Please try again.","error")}}})}),window.location.pathname.includes("post.html")&&loadSinglePost();const fetchTrendingPosts=async()=>{const e=await apiFetch(`${API_URL}/trending?limit=5`),t=await e.json();document.getElementById("trending-list").innerHTML=t.map((e,t)=>`\n    <li>\n      <span class="trending-rank">${["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][t]||`#${t+1}`}</span>\n      <a href="post.html?id=${e._id}" class="trending-title">${e.title}</a>\n      <i class="fa-solid fa-bolt trending-icon" title="Trending now"></i>\n    </li>\n  `).join("")},profileEdit=document.getElementById("profile-edit");profileEdit?.addEventListener("click",()=>{window.location.href="dashboard.html"}),document.addEventListener("DOMContentLoaded",async()=>{const e=await checkUser();window.currentUser=e,window.location.pathname.endsWith("index.html")?(fetchPosts(),fetchTrendingPosts()):window.location.pathname.endsWith("my-posts.html")&&fetchMyPosts(),refreshPage()});