const API_BASE="https://buzzink.onrender.com",API_URL="/api/posts",AUTH_URL="/api/auth",COMMENTS_URL="/api/comments";let postStatus="published";const menuToggle=document.querySelector(".menu-toggle"),mobileMenu=document.getElementById("mobileMenu"),searchIcon=document.querySelector(".search-icon"),mobileSearch=document.getElementById("mobileSearch"),logo=document.querySelector(".logo"),allPostsBtn=document.querySelector(".all-posts-btn"),myPosts=document.getElementById("myPosts"),savedPosts=document.getElementById("savedPosts"),myDrafts=document.getElementById("myDrafts"),search=document.querySelectorAll(".search"),postImages=document.querySelectorAll(".post-image"),DEFAULT_AVATAR="https://i.postimg.cc/KvF0rh0Q/custom-default-avatar.png";document.getElementById("canonicalUrl")?.setAttribute("href",window.location.href),window.location.pathname.endsWith("post.html")&&(async()=>{const t=new URLSearchParams(window.location.search).get("slug");if(!t)return;const e=await apiFetch(`/api/posts/${t}`),o=await e.json();document.title=`${o.title} | BuzzInk`;const n=o.content.slice(0,160);document.getElementById("postTitle")?.setAttribute("content",o.title),document.getElementById("postDescription")?.setAttribute("content",n),document.getElementById("ogTitle")?.setAttribute("content",o.title),document.getElementById("ogDescription")?.setAttribute("content",n),document.getElementById("ogImage")?.setAttribute("content",o.image||"/Images/fallback.jpg"),document.getElementById("ogUrl")?.setAttribute("content",window.location.href),document.getElementById("twitterTitle")?.setAttribute("content",o.title),document.getElementById("twitterDescription")?.setAttribute("content",n),document.getElementById("twitterImage")?.setAttribute("content",o.image||"/Images/fallback.jpg")})();const body=document.body;function applyTheme(t){"dark"===t?(body.classList.add("dark"),logo.src="/Images/logo-dark-theme_optimized_.png"):(body.classList.remove("dark"),logo.src="/Images/logo_optimized.png"),localStorage.setItem("theme",t)}function normalizeUser(t){return t?{...t,id:t.id||t._id}:null}async function updateAvatar(t){try{const e=await apiFetch("/api/users/me");if(!e.ok)return;t=await e.json();const o=document.querySelectorAll(".user-icon");o&&o.forEach(e=>{e.src=t.profilePhoto?.trim()?t.profilePhoto:DEFAULT_AVATAR}),window.currentUser=t}catch(t){console.warn("Failed to load auth user:",t)}}window.currentUser=(()=>{const t=localStorage.getItem("user");return t?normalizeUser(JSON.parse(t)):null})(),logo?.addEventListener("click",()=>{window.location.href="index.html"}),allPostsBtn?.addEventListener("click",()=>{window.location.href="all-posts.html"}),myPosts?.addEventListener("click",()=>{window.location.href="my-posts.html"}),searchIcon?.addEventListener("click",()=>{mobileSearch.classList.toggle("show"),mobileSearch.classList.contains("show")&&mobileSearch.querySelector("input").focus()}),menuToggle?.addEventListener("click",t=>{t.stopPropagation(),userMenuDetails.classList.contains("show")&&userMenuDetails.classList.remove("show"),mobileMenu.classList.toggle("active")}),window.location.pathname.endsWith("write.html")&&!localStorage.getItem("editSlug")&&localStorage.removeItem("editSlug");let posts=[],currentPage=1,totalPages=1;function renderNoResults(t){t.innerHTML='<p style="text-align:center; color:gray; font-size: 20px; font-weight: bold;">No results found...</p>'}function renderNoAuthorPost(t){t.innerHTML='<p style="text-align:center; color:gray; font-size: 20px; font-weight: bold;">You haven\'t made any posts yet...</p>'}function getImageUrl(t){return t?t.startsWith("http")?t:(t.startsWith("/uploads"),"/Images/fallback.jpg"):"/Images/fallback.jpg"}function formatText(t){return t.replace(/\n/g,"<br>")}async function fetchPosts(t=1,e=6){try{posts=[];const o=await apiFetch(`${API_URL}?page=${t}&limit=${e}`),n=await o.json();posts=Array.isArray(n.posts)?n.posts:[],currentPage=n.currentPage??1,totalPages=n.totalPages??1,refreshPage(),renderPagination()}catch(t){console.error("Error fetching posts:",t),showToast("Something went wrong while displaying posts!","error")}}async function fetchMyPosts(t=1,e=6){try{posts=[];const o=await apiFetch(`${API_URL}/mine?page=${t}&limit=${e}`);if(!o.ok){const t=await o.text();throw new Error(t||"Failed to fetch your posts")}const n=await o.json();posts=Array.isArray(n.posts)?n.posts:[],currentPage=n.currentPage||1,totalPages=n.totalPages||1;if(displayPosts("myPostsContainer"),renderPagination(),0===posts.length){const t=document.getElementById("myPostsContainer");t&&renderNoAuthorPost(t)}}catch(t){console.error("Error fetching my posts:",t),showToast("Failed to load your posts!","error")}}function displayPosts(t,e=null){const o=window.currentUser?._id||window.currentUser?.id,n=document.getElementById(t);if(!n)return;n.innerHTML="";let s=[...posts];if("allPostsContainer"!==t&&"featuredPostsContainer"!==t||(s=s.filter(t=>"drafts"!==t.status)),"allPostsContainer"===t){const t=document.getElementById("categoryFilter");if(t){const e=t?.value;"all"!==e&&(s=s.filter(t=>t.category===e))}}"myPostsContainer"===t&&o&&(s=s.filter(t=>{const e="object"==typeof t.authorId&&null!==t.authorId?t.authorId._id:t.authorId;return String(e)===String(o)})),e&&(s=s.slice(0,e)),0!==s.length?s.forEach(t=>{const e=document.createElement("div");e.classList.add("post");const s=t.content.length>150?t.content.substring(0,150)+"...":t.content,a="object"==typeof t.authorId&&null!==t.authorId?t.authorId._id:t.authorId,r="object"==typeof t.authorId&&null!==t.authorId?t.authorId.name:t.authorName||"Unknown",i=o&&String(a)===String(o);e.innerHTML=`\n      ${t.image?`<a href="post.html?slug=${t.slug}">\n             <img src="${getImageUrl(t.image)}" alt="${t.title}" class="post-image" loading="lazy">\n           </a>`:""}\n        <p class="tag">${t.category}</p>\n        <h2>\n          <a href="post.html?slug=${t.slug}" class="post-link">${t.title}</a>\n          ${"draft"===t.status?'<span class="draft-badge">Draft</span>':""}\n        </h2>\n        <p>${s} <a href="post.html?slug=${t.slug}" class="read-more">Read more</a></p>\n        <a href="profile.html?id=${a}" class="author"><em>By ${r}</em></a>\n        <small>${new Date(t.displayDate).toLocaleString()}</small>\n        <br>\n        <div class="post-interactions-container">\n          <div class="post-interactions">\n            <button class="like-btn ${t.likedByUser?"liked":""}" data-post-id="${t._id}">\n              <i class="${t.likedByUser?"fa-solid":"fa-regular"} fa-heart"></i>\n              <span class="like-count">${t.likesCount||0}</span>\n            </button>\n            <button class="comment-btn" data-post-id="${t._id}">\n              <i class="fa-regular fa-comment"></i>\n              <span class="comment-count">${t.commentsCount||0}</span>\n            </button>\n            <button class="share-btn">\n              <i class="fa-solid fa-share"></i>\n              <span class="share-count"></span>\n            </button>\n          </div>\n          <span class="liked-by likes-info">No likes yet</span>\n        </div>\n        <div class="comments-section">\n          <form class="comment-form">\n            <input type="text" class="comment-input" placeholder="Write a comment..." required />\n            <button type="submit">Comment</button>\n          </form>\n          <div class="comments-list"></div>\n        </div>\n        ${i?`\n        <div class="post-actions">\n            <button class="edit-btn btn" data-slug="${t.slug}">Edit</button>\n            <button class="delete-btn btn" data-slug="${t.slug}">Delete</button>\n        </div>\n        `:""}\n    `,n.appendChild(e);const l=e.querySelector(".post-image");l&&(l.onerror=function(){this.onerror=null,this.src="/Images/fallback.jpg"});const c=e.querySelector(".like-btn"),d=c.querySelector("i"),m=e.querySelector(".liked-by"),u=Array.isArray(t.likes)?t.likes.map(t=>"object"==typeof t?t._id:t):[];o&&(u.includes(o)||t.likedByUser)?(c.classList.add("liked"),d.className="fa-solid fa-heart"):(c.classList.remove("liked"),d.className="fa-regular fa-heart"),t.likedBy&&0!==t.likedBy.length?1===t.likedBy.length?m.textContent=`Liked by ${t.likedBy[0]}`:m.textContent=`Liked by ${t.likedBy[0]} and ${t.likedBy.length-1} others`:m.textContent="No likes yet";const g=e.querySelector(".comment-count");updateCommentCount(t._id,g)}):renderNoResults(n)}async function addPost(t,e,o,n,s="published"){const a=new FormData;a.append("title",t),a.append("content",e),a.append("category",o),a.append("status",s),n&&a.append("image",n);const r=await apiFetch(`${API_URL}`,{method:"POST",body:a});if(!r.ok)throw new Error("Failed to add post");return await r.json()}async function deletePost(t){if(confirm("Are you sure you want to delete this post?"))try{const e=await apiFetch(`${API_URL}/${t}`,{method:"DELETE"});if(!e.ok){const t=await e.text();throw new Error(t||"Failed to delete post")}showToast("Post deleted successfully!","success"),window.location.pathname.endsWith("my-posts.html")?fetchMyPosts(currentPage):fetchPosts(currentPage)}catch(t){console.error("Error deleting post:",t),showToast("Failed to delete post!","error")}}function editPost(t){localStorage.removeItem("editSlug"),localStorage.setItem("editSlug",t),window.location.href="write.html"}const postForm=document.getElementById("postForm");if(postForm){const t=localStorage.getItem("editSlug");t&&"null"!==t?((async()=>{try{const e=await apiFetch(`${API_URL}/${t}`);if(!e.ok)throw new Error("Post not found");const o=await e.json();if(document.getElementById("title").value=o.title||"",document.getElementById("content").value=o.content||"",document.getElementById("category").value=o.category||"",o.image){const t=document.getElementById("imagePreview");t.src=o.image,t.style.display="block"}}catch(t){console.error("Error loading post:",t)}})(),document.getElementById("saveDraftBtn")?.addEventListener("click",()=>{postStatus="draft"}),document.getElementById("publishBtn")?.addEventListener("click",()=>{postStatus="published"}),postForm.onsubmit=async function(e){e.preventDefault();const o=new FormData;o.append("title",document.getElementById("title").value),o.append("content",document.getElementById("content").value),o.append("category",document.getElementById("category").value),o.append("status",postStatus);const n=document.getElementById("image").files[0];n&&o.append("image",n);try{const e=await apiFetch(`${API_URL}/${t}`,{method:"PUT",body:o});e.ok?(showToast("Post updated successfully!","success"),localStorage.removeItem("editSlug"),window.location.href="all-posts.html"):console.error("Update failed:",await e.text())}catch(t){console.error("Error updating post:",t),showToast("Failed to update post!","error")}}):(localStorage.removeItem("editSlug"),postForm?.addEventListener("submit",async function(t){t.preventDefault();const e=document.getElementById("title").value,o=document.getElementById("content").value,n=document.getElementById("category").value,s=document.getElementById("image").files[0];console.log("Submitting new post:",{title:e,content:o,category:n,imageFile:s});try{const t=await addPost(e,o,n,s,postStatus);console.log("Post created successfully!",t),showToast("Post created successfully!","success"),postForm.reset(),window.location.href="all-posts.html",localStorage.removeItem("editSlug")}catch(t){console.error("Error adding post:",t),showToast("Failed to add post!","error")}}))}function refreshPage(){document.getElementById("allPostsContainer")&&displayPosts("allPostsContainer"),document.getElementById("featuredPostsContainer")&&displayPosts("featuredPostsContainer",3),document.getElementById("myPostsContainer")&&displayPosts("myPostsContainer")}function searchPosts(t){const e=t.target.value.toLowerCase()||"",o=document.getElementById("allPostsContainer")?"allPostsContainer":"featuredPostsContainer",n=document.getElementById(o);if(!n)return;const s=posts.filter(t=>t.title.toLowerCase().includes(e)||t.content.toLowerCase().includes(e)||t.category.toLowerCase().includes(e));n.innerHTML="",0!==s.length?(s.forEach(t=>{const e=document.createElement("div");e.classList.add("post"),e.innerHTML=`\n      ${t.image?`<img src="${getImageUrl(t.image)}" alt="${t.title}" class="post-image" loading="lazy">`:""}\n      <div class="post-content">\n        <p class="tag">${t.category}</p>\n        <h2>${t.title}</h2>\n        <p>${t.content}</p>\n        <p><em>By ${t.authorName||"Unknown"}</em></p>\n        <small>${new Date(t.displayDate).toLocaleString()}</small>\n      </div>\n    `,n.appendChild(e);const o=e.querySelector(".post-image");o&&(o.onerror=function(){this.onerror=null,this.src="/Images/fallback.jpg"}),e.addEventListener("click",()=>{window.location.href=`post.html?slug=${t.slug}`})}),""===e&&refreshPage()):renderNoResults(n)}function renderPagination(){const t=document.getElementById("pagination");if(t){t.innerHTML="";for(let e=1;e<=totalPages;e++){const o=document.createElement("button");o.textContent=e,o.className=e===currentPage?"pg-active":"",o?.addEventListener("click",()=>{document.getElementById("draftsContainer")?loadDrafts(e):document.getElementById("myPostsContainer")?fetchMyPosts(e):fetchPosts(e)}),t.appendChild(o)}}}document.getElementById("categoryFilter")?.addEventListener("change",()=>{displayPosts("allPostsContainer")}),search.forEach(t=>t.addEventListener("keyup",searchPosts));const userIcon=document.querySelectorAll(".user-icon"),authModal=document.getElementById("authModal"),closeModal=document.getElementById("closeModal"),loginTab=document.getElementById("loginTab"),registerTab=document.getElementById("registerTab"),loginForm=document.getElementById("loginForm"),registerForm=document.getElementById("registerForm"),writePostBtns=document.querySelectorAll(".write-post"),userMenuDetails=document.getElementById("userMenuDetails"),logoutBtn=document.getElementById("logoutBtn");function logout(t=!1){localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),window.currentUser=null,updateUI(null),t||showToast("You have been logged out.","info")}async function checkUser(){if(!localStorage.getItem("token"))return updateUI(null),updateAvatar(null),null;try{const t=await apiFetch(`${AUTH_URL}/me`);if(!t.ok)throw new Error("Not authenticated");const e=normalizeUser((await t.json()).user);return localStorage.setItem("user",JSON.stringify(e)),window.currentUser=e,updateUI(e),updateAvatar(e),e}catch{return logout(!0),null}}function updateUI(t){t?.id?userIcon.forEach(e=>e.title=`Logged in as ${t.name}`):(userIcon.forEach(t=>t.title="Click to Login/Register"),userMenuDetails?.classList.remove("show"))}async function apiFetch(t,e={}){let o=localStorage.getItem("token");e.headers||(e.headers={}),o&&(e.headers.Authorization=`Bearer ${o}`);const n=t;let s=await fetch(n,{credentials:"include",...e});return 401===s.status&&(o=await refreshToken(),o&&(e.headers.Authorization=`Bearer ${o}`,s=await fetch(n,{credentials:"include",...e}))),s}async function refreshToken(){const t=localStorage.getItem("refreshToken");if(!t)return null;try{const e=await fetch(`${AUTH_URL}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:t})});if(!e.ok)throw new Error("Refresh failed");const o=await e.json();localStorage.setItem("token",o.token),o.refreshToken&&localStorage.setItem("refreshToken",o.refreshToken);const n=normalizeUser(o.user);return localStorage.setItem("user",JSON.stringify(n)),window.currentUser=n,updateUI(n),o.token}catch(t){return null}}function showToast(t,e="info",o=5e3){const n=document.getElementById("toast-container");if(!n)return;const s=document.createElement("div");s.className=`toast toast-${e}`;const a=document.createElement("i");a.className="success"===e?"fas fa-check-circle":"error"===e?"fas fa-exclamation-circle":"fas fa-info-circle",s.appendChild(a);const r=document.createElement("span");r.textContent=t,s.appendChild(r),n.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.5s forwards",s.addEventListener("animationend",()=>s.remove())},o)}async function handleLike(t){const e=t.dataset.postId,o=t.querySelector("i"),n=t.querySelector(".like-count"),s=t.closest(".post-interactions-container")?.querySelector(".liked-by"),a=t.classList.contains("liked"),r=localStorage.getItem("token"),i=localStorage.getItem("refreshToken");if(r||i)try{let r;r=a?await apiFetch(`/api/posts/${e}/unlike`,{method:"POST"}):await apiFetch(`/api/posts/${e}/like`,{method:"POST"});const i=await r.json();r.ok?(a?(t.classList.remove("liked"),o.className="fa-regular fa-heart"):(t.classList.add("liked"),o.className="fa-solid fa-heart"),n.textContent=i.likes??0,i.likedBy&&i.likedBy.length>0?1===i.likedBy.length?s.textContent=`Liked by ${i.likedBy[0]}`:s.textContent=`Liked by ${i.likedBy[0]} and ${i.likedBy.length-1} others`:s.textContent="No likes yet"):showToast(`Failed to update likes: ${i.message}`,"error")}catch(t){console.error("Like action failed:",t),showToast("Error updating like. Please try again.","error")}else showToast("Please log in to like or unlike posts.","error")}async function toggleComments(t){const e=t.dataset.postId;if(!e)return;const o=window.location.pathname.endsWith("post.html"),n=o?document.getElementById("singlePostContainer"):t.closest(".post");if(!n)return;const s=n.querySelector(".comments-section"),a=s?.querySelector(".comments-list");s&&a&&(o||s.classList.toggle("show"),(o||s.classList.contains("show"))&&await fetchComments(e,a))}async function handleDeleteComment(t){if("true"===t.dataset.deleting)return;t.dataset.deleting="true";const e=t.dataset.commentId;if(confirm("Are you sure you want to delete this comment?"))try{const o=await apiFetch(`${COMMENTS_URL}/${e}`,{method:"DELETE"}),n=await o.json();if(!o.ok)throw new Error(n.message||"Delete failed");{const e=t.closest(".comment");let o;if(e&&e.remove(),window.location.pathname.endsWith("post.html")){const t=document.getElementById("singlePostContainer");o=t?.querySelector(".comment-count")}else{const e=t.closest(".post");o=e?.querySelector(".comment-count")}if(o){const t=parseInt(o.textContent)||0;o.textContent=Math.max(0,t-1)}showToast("Comment deleted successfully!","success")}}catch(t){console.error("Error deleting comment:",t),showToast("Error deleting comment. Please try again.","error")}finally{t.dataset.deleting="false"}else t.dataset.deleting="false"}async function fetchComments(t,e,o=3){try{e.innerHTML='<p class="loading-comments">Loading comments...</p>';const n=await apiFetch(`${COMMENTS_URL}/post/${t}?_=${Date.now()}`);if(!n.ok)throw new Error("Failed to fetch comments");const s=await n.json();if(e.innerHTML="",0===s.length)return void(e.innerHTML="<p class='no-comments'>No comments yet. Be the first to comment!</p>");const a=s.slice(0,o);if(renderComments(a,e),s.length>o){const t=document.createElement("button");t.classList.add("view-more-btn"),t.textContent=`View all ${s.length} comments`;const o=document.createElement("div");o.classList.add("comments-scroll-container"),o.style.display="none",renderComments(s,o);let n=!1;t.addEventListener("click",()=>{n=!n,n?(e.innerHTML="",e.appendChild(o),e.appendChild(t),o.style.display="block",t.textContent="View less comments"):(e.innerHTML="",renderComments(a,e),t.textContent=`View all ${s.length} comments`,e.appendChild(t))}),e.appendChild(t)}}catch(t){console.error("Error fetching comments:",t),e.innerHTML="<p class='error-comments'>Failed to load comments.</p>"}}function renderComments(t,e){const o=window.currentUser?.id||window.currentUser?._id;t.forEach(t=>{const n=document.createElement("div");n.classList.add("comment");const s="object"==typeof t.authorId?t.authorId._id:t.authorId,a=o&&s&&s.toString()===o.toString();n.innerHTML=`\n      <div class="comment-header">\n        <p><strong class="comment-author" style="cursor: pointer;">${t.authorId?.name||"Anonymous"}:</strong> ${formatText(t.text)}</p>\n        ${a?`<div class="comment-menu">\n                  <button class="menu-btn">â‹®</button>\n                  <div class="menu-options hidden">\n                    <button class="delete-comment-btn" data-comment-id="${t._id}">Delete</button>\n                  </div>\n                </div>`:""}\n      </div>  \n      <small>${new Date(t.createdAt).toLocaleString()}</small>\n    `,e.appendChild(n);const r=n.querySelector(".comment-author");r?.addEventListener("click",()=>{window.location.href=`profile.html?id=${t.authorId?._id}`})})}async function postComment(t,e,o,n){try{const s=localStorage.getItem("token"),a=await apiFetch(`${COMMENTS_URL}/post/${t}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({text:e})});if(!a.ok)throw new Error("Failed to post comment");{const e=await a.json(),s=document.createElement("div");s.classList.add("comment"),s.innerHTML=`\n        <div class="comment-header">\n          <p><strong>You:</strong> ${formatText(e.text)}</p>\n          <div class="comment-menu">\n            <button class="menu-btn">â‹®</button>\n            <div class="menu-options hidden">\n              <button class="delete-comment-btn" data-comment-id="${e._id}">Delete</button>\n            </div>\n          </div>\n        </div>\n        <small>${new Date(e.createdAt).toLocaleString()}</small>\n      `,o.prepend(s),n&&await updateCommentCount(t,n),showToast("Comment posted successfully!","success")}}catch(t){console.error("Error posting comment:",t),showToast("Failed to post comment","error")}}async function updateCommentCount(t,e){try{const o=await apiFetch(`${COMMENTS_URL}/post/${t}`);if(!o.ok)throw new Error("Failed to fetch comment count");const n=(await o.json()).length;0===n?(e.textContent="0",e.title="No comments yet"):(e.textContent=n,e.title=`${n} comment${n>1?"s":""}`)}catch(t){console.error("Error fetching comment count:",t),e.textContent="0"}}function injectPostJsonLd(t){const e=document.getElementById("post-jsonld");e&&e.remove();const o={"@context":"https://schema.org","@type":"Article",headline:t.title,description:t.content.slice(0,160),image:t.image?[t.image]:[],author:{"@type":"Person",name:t.authorName||"BuzzInk Contributor"},publisher:{"@type":"Organization",name:"BuzzInk",logo:{"@type":"ImageObject",url:"https://buzzink.onrender.com/Images/logo_optimized.png"}},datePublished:t.displayDate||t.date,dateModified:t.updatedAt||t.date,mainEntityOfPage:{"@type":"WebPage","@id":window.location.href}},n=document.createElement("script");n.type="application/ld+json",n.id="post-jsonld",n.textContent=JSON.stringify(o),document.head.appendChild(n)}async function loadSinglePost(){const t=new URLSearchParams(window.location.search).get("slug");if(t){try{const e=await apiFetch(`${API_URL}/${t}`);if(!e.ok)throw new Error("Failed to fetch post");const o=await e.json(),n=window.currentUser?._id||window.currentUser?.id,s="object"==typeof o.authorId&&null!==o.authorId?o.authorId._id:o.authorId,a="object"==typeof o.authorId&&null!==o.authorId?o.authorId.name:o.authorName||"Unknown";if("draft"===o.status&&(!n||String(n)!==String(s)))return void(document.getElementById("singlePostContainer").innerHTML="<p>This draft is not published.</p>");const r=n&&String(s)===String(n),i=document.getElementById("singlePostContainer");i.innerHTML=`\n      ${o.image?`<img src="${getImageUrl(o.image)}" alt="${o.title}" class="post-image" loading="lazy">`:""}\n      <h1>${o.title}</h1>\n      <p class="tag">${o.category}</p>\n      <p onclick="window.location.href='profile.html?id=${s}'" style="cursor: pointer;" class="author"><em>By ${a}</em></p>\n      <small>${new Date(o.displayDate).toLocaleString()}</small>\n      <div class="content">\n        <p>${formatText(o.content)}</p>\n      </div>\n      <div class="post-interactions-container">\n        <div class="post-interactions">\n          <button class="like-btn ${o.likedByUser?"liked":""}" data-post-id="${o._id}">\n            <i class="${o.likedByUser?"fa-solid":"fa-regular"} fa-heart"></i>\n            <span class="like-count">${o.likesCount||0}</span>\n          </button>\n          <button class="comment-btn" data-post-id="${o._id}">\n            <i class="fa-regular fa-comment"></i>\n            <span class="comment-count">${o.commentsCount||0}</span>\n          </button>\n          <button class="share-btn">\n            <i class="fa-solid fa-share"></i>\n            <span class="share-count"></span>\n          </button>\n          <span class="bookmark ${o.savedByUser?"saved":""}" data-saved="${o.savedByUser?"true":"false"}" data-slug="${o.slug}">\n            <i class="${o.savedByUser?"fa-solid":"fa-regular"} fa-bookmark"></i>\n          </span>\n        </div>\n        <span class="liked-by likes-info">No likes yet</span>\n      </div>\n      <div class="comments-section show">\n        <form class="comment-form">\n          <input type="text" class="comment-input" placeholder="Write a comment..." required />\n          <button type="submit">Comment</button>\n        </form>\n        <div class="comments-list"></div>\n      </div>\n      ${r?`\n      <div class="post-actions">\n        <button class="edit-btn btn" data-slug="${o.slug}">Edit</button>\n        <button class="delete-btn btn" data-slug="${o.slug}">Delete</button>\n      </div>`:""}\n    `;const l=i.querySelector(".post-image");l&&(l.onerror=function(){this.onerror=null,this.src="/Images/fallback.jpg"});const c=i?.querySelector(".like-btn"),d=c?.querySelector("i"),m=i?.querySelector(".liked-by"),u=Array.isArray(o.likes)?o.likes.map(t=>"object"==typeof t?t._id:t):[];n&&(u.includes(n)||o.likedByUser)?(c.classList.add("liked"),d.className="fa-solid fa-heart"):(c.classList.remove("liked"),d.className="fa-regular fa-heart"),o.likedBy&&0!==o.likedBy.length?1===o.likedBy.length?m.textContent=`Liked by ${o.likedBy[0]}`:m.textContent=`Liked by ${o.likedBy[0]} and ${o.likedBy.length-1} others`:m.textContent="No likes yet";const g=i.querySelector(".comment-count");updateCommentCount(o._id,g);const h=document.querySelector(".comments-section"),p=h.querySelector(".comments-list");h&&p&&await fetchComments(o._id,p,1/0);const y=i.querySelector(".bookmark");y.addEventListener("click",async()=>{const t=localStorage.getItem("token"),e=y.dataset.slug,o="true"===y.dataset.saved;if(!t)return void showToast("Please log in to save posts");y.classList.add("clicked"),setTimeout(()=>y.classList.remove("clicked"),200);const n=o?`/api/posts/${e}/unsave`:`/api/posts/${e}/save`;try{const t=await apiFetch(n,{method:"POST"});await t.json();!function(t){y.dataset.saved=t?"true":"false",y.classList.toggle("saved",t);const e=y.querySelector("i");e.classList.toggle("fa-solid",t),e.classList.toggle("fa-regular",!t)}(!o),showToast(o?"Removed from saved posts":"Post saved","success")}catch(t){console.error("Failed to toggle bookmark",t),showToast("Something went wrong","error")}}),injectPostJsonLd(o)}catch(t){console.error(t),document.getElementById("singlePostContainer").innerHTML="<p>Error loading post.</p>"}fetchRelatedPosts(t)}}userIcon.forEach(t=>t?.addEventListener("click",()=>{const t=localStorage.getItem("user"),e=t?JSON.parse(t):null;e&&e.id?(userMenuDetails.classList.toggle("show"),authModal.classList.add("hidden")):(userMenuDetails.classList.add("hidden"),authModal.classList.remove("hidden"),loginTab.classList.add("active"),registerTab.classList.remove("active"),loginForm.classList.remove("hidden"),registerForm.classList.add("hidden"),loginForm?.reset(),registerForm?.reset())})),document.addEventListener("click",t=>{!userMenuDetails?.classList.contains("show")||userMenuDetails.contains(t.target)||[...userIcon].some(e=>e.contains(t.target))||userMenuDetails.classList.remove("show"),!mobileMenu?.classList.contains("active")||mobileMenu.contains(t.target)||menuToggle.contains(t.target)||mobileMenu.classList.remove("active")}),closeModal?.addEventListener("click",()=>{authModal.classList.add("hidden")}),loginTab?.addEventListener("click",()=>{loginForm.classList.remove("hidden"),registerForm.classList.add("hidden"),loginTab.classList.add("active"),registerTab.classList.remove("active")}),registerTab?.addEventListener("click",()=>{registerForm.classList.remove("hidden"),loginForm.classList.add("hidden"),registerTab.classList.add("active"),loginTab.classList.remove("active")}),writePostBtns.forEach(t=>{t.addEventListener("click",t=>{const e=localStorage.getItem("user"),o=e?JSON.parse(e):null;o&&o.id?(localStorage.removeItem("editSlug"),window.location.href="write.html"):(t.preventDefault(),authModal.classList.remove("hidden"),loginTab.classList.add("active"),registerTab.classList.remove("active"),loginForm.classList.remove("hidden"),registerForm.classList.add("hidden"))})}),loginForm?.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("loginEmail").value,o=document.getElementById("loginPassword").value;console.log("Login Triggered");const n=await apiFetch(`${AUTH_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:o})}),s=await n.json();console.log("Login response:",s),n.ok||showToast(`Login failed: ${s.message||"Unknown error"}`,"error");const a=normalizeUser(s.user);localStorage.setItem("token",s.token),localStorage.setItem("refreshToken",s.refreshToken),localStorage.setItem("user",JSON.stringify(a)),window.currentUser=a,localStorage.setItem("role",a.role),"admin"===a.role&&(window.location.href="admin.html"),updateUI(a),updateAvatar(a),authModal.classList.add("hidden"),loginForm.reset(),showToast(`Welcome back, ${a.name}!`,"success"),refreshPage()}),registerForm?.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("registerName").value,o=document.getElementById("registerEmail").value,n=document.getElementById("registerPassword").value,s=await apiFetch(`${AUTH_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:o,password:n})}),a=await s.json();console.log("Register response:",a),s.ok||showToast(`Registration failed: ${a.message||"Unknown error"}`,"error");const r=normalizeUser(a.user);localStorage.setItem("token",a.token),localStorage.setItem("refreshToken",a.refreshToken),localStorage.setItem("user",JSON.stringify(r)),window.currentUser=r,localStorage.setItem("role",r.role),updateUI(r),updateAvatar(r),authModal.classList.add("hidden"),registerForm.reset(),showToast(`Welcome, ${r.name}! Your account has been created.`,"success")}),logoutBtn?.addEventListener("click",()=>{logout(),window.location.href="index.html"}),document.addEventListener("click",async t=>{const e=t.target.closest(".edit-btn");if(e)return t.preventDefault(),t.stopPropagation(),void editPost(e.dataset.slug);const o=t.target.closest(".delete-btn");if(o)return t.preventDefault(),t.stopPropagation(),void deletePost(o.dataset.slug);const n=t.target.closest(".like-btn");if(n)return t.preventDefault(),void handleLike(n);const s=t.target.closest(".comment-btn");if(s)return t.preventDefault(),void toggleComments(s);const a=t.target.closest(".delete-comment-btn");a&&(t.preventDefault(),t.stopPropagation(),handleDeleteComment(a));const r=t.target.closest(".menu-btn"),i=t.target.closest(".menu-options");if(r||i){if(r){r.nextElementSibling.classList.toggle("hidden")}}else document.querySelectorAll(".menu-options").forEach(t=>t.classList.add("hidden"))}),document.addEventListener("submit",async t=>{const e=t.target.closest(".comment-form");if(!e)return;t.preventDefault();const o=e.querySelector(".comment-input"),n=o.value.trim();if(!n)return;let s,a,r,i;if(window.location.pathname.endsWith("post.html")?(s=document.getElementById("singlePostContainer"),a=s.querySelector(".comments-list"),r=s.querySelector(".comment-btn").dataset.postId,i=s.querySelector(".comment-count")):(s=e.closest(".post"),a=s.querySelector(".comments-list"),r=s.querySelector(".like-btn").dataset.postId,i=s.querySelector(".comment-count")),!window.currentUser||!localStorage.getItem("token"))return showToast("Please log in to comment.","error"),void(o.value="");await postComment(r,n,a,i),o.value=""});const fetchTrendingPosts=async()=>{const t=await apiFetch(`${API_URL}/trending?limit=5`),e=await t.json();document.getElementById("trending-list").innerHTML=e.map((t,e)=>`\n    <li>\n      <span class="trending-rank">${["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][e]||`#${e+1}`}</span>\n      <a href="post.html?slug=${t.slug}" class="trending-title">${t.title}</a>\n      <i class="fa-solid fa-bolt trending-icon" title="Trending now"></i>\n    </li>\n  `).join("")};function renderRelatedPosts(t){const e=document.getElementById("related-posts-container");t.length?e.innerHTML=t.map(t=>`\n      <article class="related-post-card">\n        <h4><a href="post.html?slug=${t.slug}">${t.title}</a></h4>\n        <small>${t.category}</small>\n      </article>\n    `).join(""):e.innerHTML="<p>No related posts found.</p>"}const fetchRelatedPosts=async t=>{try{const e=await apiFetch(`${API_URL}/slug/${t}/related`);renderRelatedPosts(await e.json())}catch(t){console.error("Failed to fetch related posts.",t)}},profileEdit=document.getElementById("profile-edit");function initForgotPassword(){const t=document.getElementById("forgotPasswordLink"),e=document.getElementById("forgotPasswordModal"),o=document.getElementById("closeForgotModal"),n=document.getElementById("forgotPasswordForm");t&&t.addEventListener("click",t=>{t.preventDefault(),e.classList.remove("hidden")}),o&&o.addEventListener("click",()=>{e.classList.add("hidden")}),n&&n.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("forgotEmail").value.trim();try{const t=await fetch("/api/auth/forgot-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o})});showToast((await t.json()).message||"Check your email for the reset link.","success"),e.classList.add("hidden")}catch(t){console.error(t),showToast("Failed to send reset link. Try again.","error")}})}profileEdit?.addEventListener("click",()=>{window.location.href="dashboard.html"});const savedPostsContainer=document.getElementById("savedPostsContainer");async function loadSavedPosts(){try{e=[];const t=await apiFetch(`${API_URL}/saved/me`);if(!t.ok)throw new Error("Failed to fetch");const e=await t.json();if(0===e.length)return void(savedPostsContainer.innerHTML="<p>You have no saved posts yet.</p>");savedPostsContainer.innerHTML=e.map(t=>`\n      <article class="post-card">\n        ${t.image?`\n          <img \n            src="${getImageUrl(t.image)}" \n            alt="${t.title}" \n            class="post-image"\n            loading="lazy"\n            onclick="window.location.href='post.html?slug=${t.slug}'"\n          >\n        `:""}\n        <div class="post-body" onclick="window.location.href='post.html?slug=${t.slug}'">\n          <h2>${t.title}</h2>\n          <p class="tag">${t.category}</p>\n          <p class="excerpt">\n            ${t.content.slice(0,150)}...\n          </p>\n          <div class="post-meta">\n            <small>By ${t.authorId?.name||"Unknown"}</small>\n            <small>${new Date(t.displayDate).toLocaleDateString()}</small>\n          </div>\n        </div>\n        <button \n          class="bookmark saved"\n          data-slug="${t.slug}"\n          title="Remove from saved"\n        >\n          <i class="fa-solid fa-bookmark"></i>\n        </button>\n      </article>\n    `).join(""),document.querySelectorAll(".bookmark").forEach(t=>{t.addEventListener("click",async e=>{e.stopPropagation();const o=t.dataset.slug;try{await apiFetch(`${API_URL}/${o}/unsave`,{method:"POST"}),t.closest(".post-card").remove(),showToast("Removed from saved posts","success")}catch(t){console.error(t),showToast("Failed to remove","error")}})})}catch(t){console.error(t),savedPostsContainer.innerHTML="<p>Error loading saved posts.</p>"}}async function loadDrafts(){try{e=[];const t=await apiFetch("/api/posts/mine?status=draft"),e=(await t.json()).posts||[],o=document.getElementById("draftsContainer");if(o.innerHTML="",!e.length)return void(o.innerHTML="<p>No drafts yet.</p>");e.forEach(t=>{o.innerHTML+=`\n        <div class="post draft">\n          <h3>${t.title||"Untitled Draft"}</h3>\n          <small>Last edited: ${new Date(t.updatedAt).toLocaleString()}</small>\n          <div class="post-actions">\n            <button class="edit-btn btn" data-slug="${t.slug}">Edit</button>\n            <button class="delete-btn btn" data-slug="${t.slug}">Delete</button>\n          </div>\n        </div>\n      `})}catch(t){console.error("Failed to load drafts",t)}}myDrafts?.addEventListener("click",()=>{window.location.href="drafts.html"}),savedPosts?.addEventListener("click",()=>{window.location.href="saved.html"});const settings=document.getElementById("settings");settings?.addEventListener("click",()=>{window.location.href="settings.html"});const themeToggle=document.getElementById("themeToggle"),root=document.documentElement,savedTheme=localStorage.getItem("theme");"dark"===savedTheme?(root.setAttribute("data-theme","dark"),themeToggle&&(themeToggle.checked=!0)):root.setAttribute("data-theme","light"),themeToggle?.addEventListener("change",()=>{themeToggle.checked?(root.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark"),logo.src="/Images/logo-dark-theme_optimized_.png"):(root.setAttribute("data-theme","light"),localStorage.setItem("theme","light"),logo.src="/Images/logo_optimized.png")}),document.addEventListener("DOMContentLoaded",async()=>{applyTheme(localStorage.getItem("theme")||"light");const t=await checkUser();window.currentUser=t,await updateAvatar(t),initForgotPassword(),window.location.pathname.endsWith("index.html")?(fetchPosts(),fetchTrendingPosts()):window.location.pathname.endsWith("my-posts.html")?fetchMyPosts():window.location.pathname.endsWith("post.html")?loadSinglePost():window.location.pathname.endsWith("saved.html")?loadSavedPosts():window.location.pathname.endsWith("drafts.html")?loadDrafts():fetchPosts(),refreshPage()});export{showToast,apiFetch};