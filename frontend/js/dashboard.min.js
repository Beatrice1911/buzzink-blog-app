async function refreshAccessToken(){try{console.log("Refreshing with token:",refreshTokenDashboard);const e=await fetch(REFRESH_URI,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:refreshTokenDashboard})}),t=await e.json();if(e.ok&&t.token&&t.refreshToken)return localStorage.setItem("token",t.token),localStorage.setItem("refreshToken",t.refreshToken),tokenDashboard=t.token,refreshTokenDashboard=t.refreshToken,console.log("Token refreshed successfully!"),!0}catch(e){return console.error("Error refreshing token:",e),!1}}async function loadProfile(){try{const e=await fetch(API_URI,{headers:{Authorization:`Bearer ${tokenDashboard}`}}),t=await e.json();if(401===e.status){console.warn("Access token expired, trying refresh...");const e=await refreshAccessToken();return e?loadProfile():(showToastUser("Session expired. Please log in again.","error"),void(window.location.href="index.html"))}if(!e.ok)throw new Error(t.message||"Failed to fetch profile");document.getElementById("userName").textContent=t.name,document.getElementById("userEmail").textContent=t.email,document.getElementById("userBio").textContent=t.bio||"No bio added yet.",document.getElementById("joinedDate").textContent=new Date(t.createdAt).toDateString();const o="https://i.postimg.cc/KvF0rh0Q/custom-default-avatar.png";let r;t.profilePhoto?(r=t.profilePhoto.startsWith("http")?t.profilePhoto:`http://localhost:5000${t.profilePhoto}`,document.getElementById("removePhotoBtn").style.display="block"):r=o,document.getElementById("profilePhotoPreview").src=r,console.log("Profile image URL: ",r),document.getElementById("name").value=t.name,document.getElementById("bio").value=t.bio||""}catch(e){console.error("Error loading profile:",e)}}function showToastUser(e,t="info",o=5e3){const r=document.getElementById("toast-container");if(!r)return;const n=document.createElement("div");n.className=`toast toast-${t}`;const a=document.createElement("i");a.className="success"===t?"fas fa-check-circle":"error"===t?"fas fa-exclamation-circle":"fas fa-info-circle",n.appendChild(a);const s=document.createElement("span");s.textContent=e,n.appendChild(s),r.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.5s forwards",n.addEventListener("animationend",()=>n.remove())},o)}const API_URI="http://localhost:5000/api/users/me",REFRESH_URI="http://localhost:5000/api/auth/refresh";let tokenDashboard=localStorage.getItem("token"),refreshTokenDashboard=localStorage.getItem("refreshToken");const saveChangesBtn=document.getElementById("saveChangesBtn");saveChangesBtn.addEventListener("click",async e=>{e.preventDefault();const t=document.getElementById("name").value.trim(),o=document.getElementById("bio").value.trim(),r=document.getElementById("profilePhoto"),n=r.files[0],a=new FormData;a.append("name",t),a.append("bio",o),n&&a.append("profilePhoto",n);try{const e=await fetch(API_URI,{method:"PUT",headers:{Authorization:`Bearer ${tokenDashboard}`},body:a}),t=await e.json();if(console.log("Update response:",t),!e.ok)throw new Error(t.message||"Failed to update profile");if(showToastUser("Profile updated successfully!","success"),t.profilePhoto){const e=t.profilePhoto.startsWith("http")?t.profilePhoto:`http://localhost:5000${t.profilePhoto}`;document.getElementById("profilePhotoPreview").src=e}document.getElementById("userName").textContent=t.name,document.getElementById("userBio").textContent=t.bio||"No bio added yet."}catch(e){console.error("Error saving changes:",e),showToastUser("Failed to update profile. Please try again.","error")}});const removePhotoBtn=document.getElementById("removePhotoBtn");removePhotoBtn.addEventListener("click",async()=>{try{const e=await fetch(API_URI,{method:"PUT",headers:{Authorization:`Bearer ${tokenDashboard}`},body:JSON.stringify({profilePhoto:null})});if(!e.ok){const t=await e.json();throw new Error(t.message||"Failed to remove profile photo")}showToastUser("Profile photo removed successfully!","success"),loadProfile();const t="https://i.postimg.cc/KvF0rh0Q/custom-default-avatar.png";document.getElementById("profilePhotoPreview").src=t}catch(e){console.error("Error removing photo:",e),showToastUser("Failed to remove profile photo. Please try again.","error")}}),loadProfile();