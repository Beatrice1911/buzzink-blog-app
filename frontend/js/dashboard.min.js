async function refreshAccessToken(){try{console.log("Refreshing with token:",refreshTokenDashboard);const e=await fetch(REFRESH_URI,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:refreshTokenDashboard})}),o=await e.json();if(e.ok&&o.token&&o.refreshToken)return localStorage.setItem("token",o.token),localStorage.setItem("refreshToken",o.refreshToken),tokenDashboard=o.token,refreshTokenDashboard=o.refreshToken,console.log("Token refreshed successfully!"),!0}catch(e){return console.error("Error refreshing token:",e),!1}}async function loadProfile(){try{const e=await fetch(API_URI,{headers:{Authorization:`Bearer ${tokenDashboard}`}}),o=await e.json();if(401===e.status){console.warn("Access token expired, trying refresh...");const e=await refreshAccessToken();return e?loadProfile():(showToastUser("Session expired. Please log in again.","error"),void(window.location.href="index.html"))}if(!e.ok)throw new Error(o.message||"Failed to fetch profile");document.getElementById("userName").textContent=o.name,document.getElementById("userEmail").textContent=o.email,document.getElementById("userBio").textContent=o.bio||"No bio added yet.",document.getElementById("joinedDate").textContent=new Date(o.createdAt).toDateString();const t="https://i.postimg.cc/KvF0rh0Q/custom-default-avatar.png";let n;o.profilePhoto?(n=o.profilePhoto.startsWith("http")?o.profilePhoto:`${API_BASE}${o.profilePhoto}`,document.getElementById("removePhotoBtn").style.display="block"):n=t,document.getElementById("profilePhotoPreview").src=n,console.log("Profile image URL: ",n),document.getElementById("name").value=o.name,document.getElementById("bio").value=o.bio||""}catch(e){console.error("Error loading profile:",e)}}function showToastUser(e,o="info",t=5e3){const n=document.getElementById("toast-container");if(!n)return;const r=document.createElement("div");r.className=`toast toast-${o}`;const a=document.createElement("i");a.className="success"===o?"fas fa-check-circle":"error"===o?"fas fa-exclamation-circle":"fas fa-info-circle",r.appendChild(a);const s=document.createElement("span");s.textContent=e,r.appendChild(s),n.appendChild(r),setTimeout(()=>{r.style.animation="slideOut 0.5s forwards",r.addEventListener("animationend",()=>r.remove())},t)}const isLocalhost="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname,API_BASE=isLocalhost?"http://localhost:5000":"",API_URI=`${API_BASE}/api/users/me`,REFRESH_URI=`${API_BASE}/api/auth/refresh`;let tokenDashboard=localStorage.getItem("token"),refreshTokenDashboard=localStorage.getItem("refreshToken");const saveChangesBtn=document.getElementById("saveChangesBtn");saveChangesBtn.addEventListener("click",async e=>{e.preventDefault();const o=document.getElementById("name").value.trim(),t=document.getElementById("bio").value.trim(),n=document.getElementById("profilePhoto"),r=n.files[0],a=new FormData;a.append("name",o),a.append("bio",t),r&&a.append("profilePhoto",r);try{const e=await fetch(API_URI,{method:"PUT",headers:{Authorization:`Bearer ${tokenDashboard}`},body:a}),o=await e.json();if(console.log("Update response:",o),!e.ok)throw new Error(o.message||"Failed to update profile");if(showToastUser("Profile updated successfully!","success"),o.profilePhoto){const e=o.profilePhoto.startsWith("http")?o.profilePhoto:`${API_BASE}${o.profilePhoto}`;document.getElementById("profilePhotoPreview").src=e}document.getElementById("userName").textContent=o.name,document.getElementById("userBio").textContent=o.bio||"No bio added yet."}catch(e){console.error("Error saving changes:",e),showToastUser("Failed to update profile. Please try again.","error")}});const removePhotoBtn=document.getElementById("removePhotoBtn");removePhotoBtn.addEventListener("click",async()=>{try{const e=await fetch(API_URI,{method:"PUT",headers:{Authorization:`Bearer ${tokenDashboard}`},body:JSON.stringify({profilePhoto:null})});if(!e.ok){const o=await e.json();throw new Error(o.message||"Failed to remove profile photo")}showToastUser("Profile photo removed successfully!","success"),loadProfile();const o="https://i.postimg.cc/KvF0rh0Q/custom-default-avatar.png";document.getElementById("profilePhotoPreview").src=o}catch(e){console.error("Error removing photo:",e),showToastUser("Failed to remove profile photo. Please try again.","error")}}),loadProfile();