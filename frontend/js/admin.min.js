import{apiFetch}from"./app.js";const token=localStorage.getItem("token"),role=localStorage.getItem("role");async function checkAdmin(){if(!localStorage.getItem("token"))return redirectHome();const e=await apiFetch("/api/users/me"),t=await e.json();return t&&"admin"===t.role?void 0:redirectHome()}function redirectHome(){alert("Access denied. Admins only."),window.location.href="/index.html"}let usersPage=1,postsPage=1,commentsPage=1;const LIMIT=10,sidebarLinks=document.querySelectorAll(".sidebar .nav-links a"),sections={Overview:document.querySelector(".overview-cards"),Users:document.getElementById("users-section"),Posts:document.getElementById("posts-section"),Comments:document.getElementById("comments-section"),Settings:document.getElementById("settings-section")};function hideAllSections(){Object.values(sections).forEach(e=>{e&&(e.style.display="none")})}function createRow(e,t,n){const o=document.createElement("tr");t.forEach(t=>{const n=document.createElement("td");n.textContent=void 0!==e[t]&&null!==e[t]?e[t]:"",o.appendChild(n)});const a=document.createElement("td");if("users"===n){const t=document.createElement("button");t.textContent="Delete",t.classList.add("btn-delete"),t.onclick=()=>deleteUser(e._id,o),a.appendChild(t)}else if("posts"===n){const t=document.createElement("button");t.textContent="Delete",t.classList.add("btn-delete"),t.onclick=()=>deletePost(e._id,o),a.appendChild(t)}else if("comments"===n){const t=document.createElement("button");t.textContent="Delete",t.classList.add("btn-delete"),t.onclick=()=>deleteComment(e._id,o),a.appendChild(t)}return o.appendChild(a),o}sidebarLinks.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),sidebarLinks.forEach(e=>e.classList.remove("active")),e.classList.add("active");const n=e.textContent.trim();hideAllSections(),"Overview"===n?sections.Overview.style.display="flex":sections[n]&&(sections[n].style.display="block")})});const userSearchInput=document.getElementById("user-search"),postSearchInput=document.getElementById("post-search"),commentSearchInput=document.getElementById("comment-search");function filterTable(e,t){const n=e.value.toLowerCase();document.querySelectorAll(`#${t} tbody tr`).forEach(e=>{e.style.display=[...e.cells].some(e=>e.textContent.toLowerCase().includes(n))?"":"none"})}function renderPagination(e,t,n,o){const a=document.getElementById(e);a.innerHTML="";for(let e=1;e<=n;e++){const n=document.createElement("button");n.textContent=e,n.classList.toggle("active",e===t),n.addEventListener("click",()=>o(e)),a.appendChild(n)}}async function loadOverviewStats(){const e=await apiFetch("/api/admin/stats"),t=await e.json();document.getElementById("total-users").textContent=t.users,document.getElementById("total-posts").textContent=t.posts,document.getElementById("total-comments").textContent=t.comments}async function loadUsers(e=usersPage){usersPage=e;const t=userSearchInput?.value||"",n=await apiFetch(`/api/admin/users?page=${e}&limit=10&search=${encodeURIComponent(t)}`),o=await n.json(),a=document.querySelector("#users-table tbody");a.innerHTML="",o.data.forEach(e=>{a.appendChild(createRow(e,["name","email","role"],"users"))}),renderPagination("users-pagination",o.page,o.pages,loadUsers)}async function loadPosts(e=postsPage){postsPage=e;const t=postSearchInput?.value||"",n=await apiFetch(`/api/admin/posts?page=${e}&limit=10&search=${encodeURIComponent(t)}`),o=await n.json(),a=document.querySelector("#posts-table tbody");a.innerHTML="",o.data.forEach(e=>{a.appendChild(createRow(e,["title","authorName","category"],"posts"))}),renderPagination("posts-pagination",o.page,o.pages,loadPosts)}async function loadComments(e=commentsPage){commentsPage=e;const t=commentSearchInput?.value||"",n=await apiFetch(`/api/admin/comments?page=${e}&limit=10&search=${encodeURIComponent(t)}`),o=await n.json(),a=document.querySelector("#comments-table tbody");a.innerHTML="",Array.isArray(o.data)?(o.data.forEach(e=>{a.appendChild(createRow(e,["userName","postTitle","content"],"comments"))}),renderPagination("comments-pagination",o.page,o.pages,loadComments)):console.error("Comments data is not an array:",o)}async function deleteUser(e,t){confirm("Are you sure you want to delete this user?")&&(await apiFetch(`/api/admin/users/${e}`,{method:"DELETE"}),loadUsers())}async function deletePost(e,t){confirm("Are you sure you want to delete this post?")&&(await apiFetch(`/api/admin/posts/${e}`,{method:"DELETE"}),loadPosts())}async function deleteComment(e,t){confirm("Are you sure you want to delete this comment?")&&(await apiFetch(`/api/admin/comments/${e}`,{method:"DELETE"}),loadComments())}userSearchInput?.addEventListener("input",()=>filterTable(userSearchInput,"users-table")),postSearchInput?.addEventListener("input",()=>filterTable(postSearchInput,"posts-table")),commentSearchInput?.addEventListener("input",()=>filterTable(commentSearchInput,"comments-table")),document.addEventListener("DOMContentLoaded",async()=>{await checkAdmin(),loadOverviewStats(),loadUsers(),loadPosts(),loadComments()});